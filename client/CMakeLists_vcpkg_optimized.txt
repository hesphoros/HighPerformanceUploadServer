# =====================================
# ğŸš€ ä¼˜åŒ–ç‰ˆæœ¬ CMakeLists.txt - ä½¿ç”¨ vcpkg é¢„ç¼–è¯‘åº“
# æ­¤ç‰ˆæœ¬é¿å…æ¯æ¬¡é‡æ–°ç¼–è¯‘ Abseilï¼Œæ˜¾è‘—æå‡æ„å»ºé€Ÿåº¦
# ä½¿ç”¨æ–¹æ³•: å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º CMakeLists.txt è¦†ç›–åŸæ–‡ä»¶
# =====================================

cmake_minimum_required(VERSION 3.16)
project(UploadClient VERSION 1.0.0)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# vcpkg/Qtè·¯å¾„
set(CMAKE_PREFIX_PATH "D:/cppsoft/vcpkg/installed/x64-windows")
set(CMAKE_TOOLCHAIN_FILE "D:/cppsoft/vcpkg/scripts/buildsystems/vcpkg.cmake")

# æŸ¥æ‰¾åº“ - ä¼˜å…ˆä½¿ç”¨ vcpkg é¢„ç¼–è¯‘ç‰ˆæœ¬
find_package(Qt6 REQUIRED COMPONENTS Core Widgets)
find_package(FlatBuffers REQUIRED)

# ğŸš€ ä¼˜åŒ–: ä½¿ç”¨ vcpkg çš„ Abseil é¢„ç¼–è¯‘åº“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
find_package(absl CONFIG)
if(absl_FOUND)
    message(STATUS "âœ… ä½¿ç”¨ vcpkg é¢„ç¼–è¯‘ Abseil åº“ (æ¨è)")
    set(USING_VCPKG_ABSEIL TRUE)
else()
    message(STATUS "âš ï¸ vcpkg Abseil æœªæ‰¾åˆ°ï¼Œå°†ä½¿ç”¨æºç æ„å»º")
    set(USING_VCPKG_ABSEIL FALSE)
endif()

# TOMLåº“æ”¯æŒ (ä½¿ç”¨æœ¬åœ°toml11)
set(TOML11_LOCAL_PATH "${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include/toml11")
if(EXISTS "${TOML11_LOCAL_PATH}/toml.hpp")
    message(STATUS "âœ… æ‰¾åˆ°æœ¬åœ°toml11åº“: ${TOML11_LOCAL_PATH}")
    set(TOML11_LOCAL_AVAILABLE TRUE)
else()
    message(WARNING "âš ï¸ æœ¬åœ°toml11åº“æœªæ‰¾åˆ°: ${TOML11_LOCAL_PATH}/toml.hpp")
    set(TOML11_LOCAL_AVAILABLE FALSE)
endif()

# spdlogåº“æ”¯æŒ (ä¼˜å…ˆvcpkgï¼Œå¤‡é€‰FetchContent)
find_package(spdlog CONFIG)
if(spdlog_FOUND)
    message(STATUS "âœ… ä½¿ç”¨ vcpkg spdlog åº“")
    set(USING_VCPKG_SPDLOG TRUE)
else()
    message(STATUS "ğŸ“¦ ä½¿ç”¨ FetchContent ä¸‹è½½ spdlog")
    set(USING_VCPKG_SPDLOG FALSE)
    
    include(FetchContent)
    FetchContent_Declare(
        spdlog
        GIT_REPOSITORY https://github.com/gabime/spdlog.git
        GIT_TAG        v1.12.0
        GIT_SHALLOW    TRUE
    )
    
    set(SPDLOG_BUILD_EXAMPLE OFF CACHE BOOL "")
    set(SPDLOG_BUILD_TESTS OFF CACHE BOOL "")
    set(SPDLOG_BUILD_BENCH OFF CACHE BOOL "")
    set(SPDLOG_FMT_EXTERNAL OFF CACHE BOOL "")
    set(SPDLOG_BUILD_SHARED OFF CACHE BOOL "")
    
    FetchContent_MakeAvailable(spdlog)
endif()

# magic_enumåº“æ”¯æŒ (ä½¿ç”¨æœ¬åœ°å¤´æ–‡ä»¶)
set(MAGIC_ENUM_LOCAL_PATH "${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/magic_enum")
if(EXISTS "${MAGIC_ENUM_LOCAL_PATH}/magic_enum.hpp")
    message(STATUS "âœ… æ‰¾åˆ°æœ¬åœ°magic_enumåº“: ${MAGIC_ENUM_LOCAL_PATH}")
    set(MAGIC_ENUM_LOCAL_AVAILABLE TRUE)
else()
    message(WARNING "âš ï¸ æœ¬åœ°magic_enumåº“æœªæ‰¾åˆ°: ${MAGIC_ENUM_LOCAL_PATH}/magic_enum.hpp")
    set(MAGIC_ENUM_LOCAL_AVAILABLE FALSE)
endif()

# å¯ç”¨Qt6çš„MOC/UIC/RCC
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# ğŸš€ æ¡ä»¶æ€§ Abseil é…ç½® - åªåœ¨éœ€è¦æ—¶ä»æºç æ„å»º
if(NOT USING_VCPKG_ABSEIL)
    # è®¾ç½® Abseil æ„å»ºé€‰é¡¹ä»¥å‡å°‘ç¼–è¯‘æ—¶é—´
    set(ABSL_ENABLE_INSTALL ON CACHE BOOL "")
    set(ABSL_BUILD_TESTING OFF CACHE BOOL "")
    set(ABSL_BUILD_MONOLITHIC_SHARED_LIBS OFF CACHE BOOL "")
    set(ABSL_USE_SYSTEM_INCLUDES ON CACHE BOOL "")
    
    # åªæœ‰åœ¨é¦–æ¬¡æ„å»ºæˆ–æºç å˜æ›´æ—¶æ‰é‡æ–°ç¼–è¯‘
    if(NOT TARGET absl::base)
        add_subdirectory(3rdParty/abseil-cpp)
    endif()
    message(STATUS "âš ï¸ ä½¿ç”¨æœ¬åœ°Abseilæºç åº“ (è¾ƒæ…¢)")
    message(STATUS "ğŸ’¡ æç¤º: å»ºè®®è¿è¡Œ 'vcpkg install abseil:x64-windows' å®‰è£…é¢„ç¼–è¯‘ç‰ˆæœ¬ä»¥åŠ é€Ÿæ„å»º")
endif()

# FlatBuffers é…ç½®
set(FBS_FILES ${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/upload_file_info.fbs)
set(FBS_GEN_DIR ${CMAKE_CURRENT_SOURCE_DIR}/generated)

# è‡ªåŠ¨æŸ¥æ‰¾ FlatBuffer ç›®å½•ä¸‹æ‰€æœ‰ .fbs æ–‡ä»¶å¹¶ç”Ÿæˆå¯¹åº” .h/.cc
file(GLOB FBS_FILES "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/*.fbs")

# æŒ‡å®š flatc.exe çš„ç»å¯¹è·¯å¾„
set(FLATC_EXE "D:/cppsoft/vcpkg/installed/x64-windows/tools/flatbuffers/flatc.exe")

set(GEN_HEADERS)
set(GEN_SOURCES)
foreach(FBS_FILE ${FBS_FILES})
    get_filename_component(FBS_NAME ${FBS_FILE} NAME_WE)
    list(APPEND GEN_HEADERS "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.h")
    list(APPEND GEN_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.cpp")
    add_custom_command(
        OUTPUT "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.h"
               "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.cpp"
        COMMAND ${FLATC_EXE} --cpp --gen-object-api -o ${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer ${FBS_FILE}
        DEPENDS ${FBS_FILE}
        COMMENT "Generating FlatBuffers C++ code from ${FBS_FILE}"
    )
endforeach()
add_custom_target(FlatBuffersGen ALL DEPENDS ${GEN_HEADERS} ${GEN_SOURCES})

# æ”¶é›†æºæ–‡ä»¶
file(GLOB_RECURSE SOURCES
    "src/*.cpp"
    "src/*.h"
)

file(GLOB_RECURSE HEADERS
    "include/*.h"
    "include/*.hpp"
)

file(GLOB_RECURSE THIRD_PARTY_SOURCES
    "3rdParty/src/*.cpp"
    "3rdParty/src/*.h"
)

file(GLOB_RECURSE THIRD_PARTY_HEADERS
    "3rdParty/include/*.h"
    "3rdParty/include/*.hpp"
)

# æ”¶é›† FlatBuffer ç›®å½•ä¸‹æ‰€æœ‰ _generated.h/_generated.cpp æ–‡ä»¶
file(GLOB FLATBUFFERS_GENERATED_SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/*_generated.h"
    "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/*_generated.cpp"
)

message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Qt6 Version: ${Qt6_VERSION}")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID}")

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(UploadClient 
    ${SOURCES} 
    ${HEADERS} 
    ${THIRD_PARTY_SOURCES} 
    ${THIRD_PARTY_HEADERS}
    ${FLATBUFFERS_GENERATED_SOURCES}
)

# ğŸš€ ä¼˜åŒ–çš„åº“é“¾æ¥é…ç½®
target_link_libraries(UploadClient PRIVATE
    Qt6::Core
    Qt6::Widgets
    flatbuffers::flatbuffers
)

# spdlog é“¾æ¥
if(USING_VCPKG_SPDLOG)
    target_link_libraries(UploadClient PRIVATE spdlog::spdlog)
else()
    target_link_libraries(UploadClient PRIVATE spdlog::spdlog)
endif()

# ğŸš€ ä¼˜åŒ–çš„ Abseil åº“é“¾æ¥
if(USING_VCPKG_ABSEIL)
    # ä½¿ç”¨ vcpkg é¢„ç¼–è¯‘ç‰ˆæœ¬
    target_link_libraries(UploadClient PRIVATE
        absl::log_severity
        absl::strings
        absl::base
        absl::log
        absl::time
    )
    message(STATUS "âœ… é“¾æ¥ vcpkg Abseil é¢„ç¼–è¯‘åº“ (å¿«é€Ÿ)")
else()
    # ä½¿ç”¨æºç æ„å»ºç‰ˆæœ¬
    target_link_libraries(UploadClient PRIVATE
        absl::log_severity
        absl::strings
        absl::base
        absl::log
        absl::time
    )
    message(STATUS "âš ï¸ é“¾æ¥æœ¬åœ°æ„å»º Abseil åº“ (è¾ƒæ…¢)")
endif()

# åŒ…å«ç›®å½•é…ç½®
target_include_directories(UploadClient PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer
)

# toml11 åŒ…å«ç›®å½•
if(TOML11_LOCAL_AVAILABLE)
    target_include_directories(UploadClient PRIVATE ${TOML11_LOCAL_PATH})
    message(STATUS "âœ… ä½¿ç”¨æœ¬åœ°toml11åº“: ${TOML11_LOCAL_PATH}")
endif()

# magic_enum åŒ…å«ç›®å½•
if(MAGIC_ENUM_LOCAL_AVAILABLE)
    target_include_directories(UploadClient PRIVATE ${MAGIC_ENUM_LOCAL_PATH})
    message(STATUS "âœ… ä½¿ç”¨æœ¬åœ°magic_enumåº“: ${MAGIC_ENUM_LOCAL_PATH}")
endif()

# ä¾èµ–å…³ç³»
add_dependencies(UploadClient FlatBuffersGen)
if(NOT USING_VCPKG_ABSEIL AND TARGET absl::base)
    add_dependencies(UploadClient absl::base)
endif()

# æ„å»ºä¼˜åŒ–æç¤º
message(STATUS "")
message(STATUS "ğŸš€ æ„å»ºä¼˜åŒ–å»ºè®®:")
if(NOT USING_VCPKG_ABSEIL)
    message(STATUS "   âš¡ è¿è¡Œ 'vcpkg install abseil:x64-windows' å¯æ˜¾è‘—åŠ é€Ÿåç»­æ„å»º")
endif()
if(NOT USING_VCPKG_SPDLOG)
    message(STATUS "   âš¡ è¿è¡Œ 'vcpkg install spdlog:x64-windows' å¯åŠ é€Ÿ spdlog æ„å»º")
endif()
message(STATUS "   ğŸ“¦ æ‰€æœ‰ vcpkg åº“å°†ç¼“å­˜ï¼Œåªéœ€å®‰è£…ä¸€æ¬¡")
message(STATUS "")