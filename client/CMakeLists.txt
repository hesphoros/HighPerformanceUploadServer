cmake_minimum_required(VERSION 3.16)
project(UploadClient VERSION 1.0.0)

# ğŸš€ æ„å»ºä¼˜åŒ–è®¾ç½®
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# å¯ç”¨æ„å»ºç¼“å­˜ä»¥åŠ é€Ÿé‡æ–°æ„å»º
set(CMAKE_CXX_COMPILER_LAUNCHER "" CACHE STRING "")
if(WIN32)
    # Windows ä¸Šä¼˜åŒ–ç¼–è¯‘å™¨è®¾ç½®
    set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
    # å¯ç”¨å¹¶è¡Œç¼–è¯‘
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MP")
endif()

# vcpkg/Qtè·¯å¾„
set(CMAKE_PREFIX_PATH "D:/cppsoft/vcpkg/installed/x64-windows")
set(CMAKE_TOOLCHAIN_FILE "D:/cppsoft/vcpkg/scripts/buildsystems/vcpkg.cmake")

# æŸ¥æ‰¾Qt6
find_package(Qt6 REQUIRED COMPONENTS Core Widgets)
find_package(FlatBuffers REQUIRED)

# TOMLåº“æ”¯æŒ (ä½¿ç”¨æœ¬åœ°toml11)
set(TOML11_LOCAL_PATH "${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include/toml11")
if(EXISTS "${TOML11_LOCAL_PATH}/toml.hpp")
    message(STATUS "âœ… æ‰¾åˆ°æœ¬åœ°toml11åº“: ${TOML11_LOCAL_PATH}")
    set(TOML11_LOCAL_AVAILABLE TRUE)
else()
    message(WARNING "âš ï¸ æœ¬åœ°toml11åº“æœªæ‰¾åˆ°: ${TOML11_LOCAL_PATH}/toml.hpp")
    set(TOML11_LOCAL_AVAILABLE FALSE)
endif()

# spdlogåº“æ”¯æŒ (ä½¿ç”¨FetchContent)
include(FetchContent)
FetchContent_Declare(
    spdlog
    GIT_REPOSITORY https://github.com/gabime/spdlog.git
    GIT_TAG        v1.12.0  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
    GIT_SHALLOW    TRUE     # åªä¸‹è½½æœ€æ–°commitï¼ŒåŠ é€Ÿä¸‹è½½
)

# é…ç½®spdlogé€‰é¡¹
set(SPDLOG_BUILD_EXAMPLE OFF CACHE BOOL "")
set(SPDLOG_BUILD_TESTS OFF CACHE BOOL "")
set(SPDLOG_BUILD_BENCH OFF CACHE BOOL "")
set(SPDLOG_FMT_EXTERNAL OFF CACHE BOOL "")  # ä½¿ç”¨å†…ç½®fmt
set(SPDLOG_BUILD_SHARED OFF CACHE BOOL "")  # é™æ€é“¾æ¥

FetchContent_MakeAvailable(spdlog)
message(STATUS "âœ… spdlogåº“å·²é€šè¿‡FetchContenté›†æˆ")

# UniConvä¾èµ–
FetchContent_Declare(
    UniConv
    GIT_REPOSITORY https://github.com/hesphoros/UniConv.git
    GIT_TAG main
    GIT_SHALLOW TRUE
)

FetchContent_MakeAvailable(UniConv)
message(STATUS "âœ… UniConvåº“å·²é€šè¿‡FetchContenté›†æˆ")

# magic_enumåº“æ”¯æŒ (ä½¿ç”¨æœ¬åœ°å¤´æ–‡ä»¶)
set(MAGIC_ENUM_LOCAL_PATH "${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/magic_enum")
if(EXISTS "${MAGIC_ENUM_LOCAL_PATH}/magic_enum.hpp")
    message(STATUS "âœ… æ‰¾åˆ°æœ¬åœ°magic_enumåº“: ${MAGIC_ENUM_LOCAL_PATH}")
    set(MAGIC_ENUM_LOCAL_AVAILABLE TRUE)
else()
    message(WARNING "âš ï¸ æœ¬åœ°magic_enumåº“æœªæ‰¾åˆ°: ${MAGIC_ENUM_LOCAL_PATH}/magic_enum.hpp")
    set(MAGIC_ENUM_LOCAL_AVAILABLE FALSE)
endif()

# å¯ç”¨Qt6çš„MOC/UIC/RCC
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# FlatBuffers é…ç½®
set(FBS_FILES ${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/upload_file_info.fbs)
set(FBS_GEN_DIR ${CMAKE_CURRENT_SOURCE_DIR}/generated)


#abseil é…ç½® - ğŸš€ æ™ºèƒ½æ£€æµ‹ä¼˜åŒ–
find_package(absl CONFIG)
if(absl_FOUND)
    message(STATUS "âœ… ä½¿ç”¨ vcpkg é¢„ç¼–è¯‘ Abseil åº“ (å¿«é€Ÿ)")
    set(USING_VCPKG_ABSEIL TRUE)
else()
    message(STATUS "ğŸ”„ vcpkg Abseil æœªæ‰¾åˆ°ï¼Œä½¿ç”¨æºç æ„å»º")
    set(USING_VCPKG_ABSEIL FALSE)
    
    # ä¼˜åŒ–æºç æ„å»ºè®¾ç½®
    set(ABSL_ENABLE_INSTALL OFF CACHE BOOL "")
    set(ABSL_BUILD_TESTING OFF CACHE BOOL "")
    set(ABSL_BUILD_MONOLITHIC_SHARED_LIBS OFF CACHE BOOL "")
    set(ABSL_USE_SYSTEM_INCLUDES ON CACHE BOOL "")
    
    if(NOT TARGET absl::base)
        message(STATUS "ğŸ”„ æ­£åœ¨æ„å»º Abseil åº“... (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)")
        add_subdirectory(3rdParty/abseil-cpp)
        message(STATUS "âœ… Abseil æºç æ„å»ºå®Œæˆ")
    else()
        message(STATUS "âš¡ Abseil å·²ç¼“å­˜ï¼Œè·³è¿‡æ„å»º")
    endif()
endif()

# è‡ªåŠ¨æŸ¥æ‰¾ FlatBuffer ç›®å½•ä¸‹æ‰€æœ‰ .fbs æ–‡ä»¶å¹¶ç”Ÿæˆå¯¹åº” .h/.cc
file(GLOB FBS_FILES "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/*.fbs")

# æŒ‡å®š flatc.exe çš„ç»å¯¹è·¯å¾„
set(FLATC_EXE "D:/cppsoft/vcpkg/installed/x64-windows/tools/flatbuffers/flatc.exe")

set(GEN_HEADERS)
set(GEN_SOURCES)
foreach(FBS_FILE ${FBS_FILES})
    get_filename_component(FBS_NAME ${FBS_FILE} NAME_WE)
    list(APPEND GEN_HEADERS "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.h")
    list(APPEND GEN_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.cpp")
    add_custom_command(
        OUTPUT "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.h"
               "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/${FBS_NAME}_generated.cpp"
        COMMAND ${FLATC_EXE} --cpp --gen-object-api -o ${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer ${FBS_FILE}
        DEPENDS ${FBS_FILE}
        COMMENT "Generating FlatBuffers C++ code from ${FBS_FILE}"
    )
endforeach()
add_custom_target(FlatBuffersGen ALL DEPENDS ${GEN_HEADERS} ${GEN_SOURCES})

# æ”¶é›† FlatBuffer ç›®å½•ä¸‹æ‰€æœ‰ _generated.h/_generated.cpp æ–‡ä»¶ï¼ˆåªæ”¶ flatc ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
file(GLOB FLATBUFFERS_GENERATED_SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/*_generated.h"
    "${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer/*_generated.cpp"
)

set(SRC_FBS ${FLATBUFFERS_GENERATED_SOURCES})

# æºæ–‡ä»¶åˆ†ç»„
set(SRC_MAIN src/main.cpp)
set(SRC_UI src/MainWindow.cpp src/FileListWidget.cpp)
set(SRC_UPLOAD src/SyncUploadQueue/Lusp_SyncUploadQueue.cpp src/SyncUploadQueue/Lusp_SyncUploadQueuePrivate.cpp src/NotificationService/Lusp_SyncFilesNotificationService.cpp)
set(SRC_FILEINFO src/FileInfo/FileInfo.cpp)
set(SRC_LOG src/log_headers.cpp)
set(SRC_HASH 3rdParty/src/hash-library/md5.cpp 3rdParty/src/hash-library/sha1.cpp 3rdParty/src/hash-library/sha256.cpp 3rdParty/src/hash-library/sha3.cpp 3rdParty/src/hash-library/crc32.cpp)
set(SRC_LOOPBACK src/AsioLoopbackIpcClient/Lusp_AsioLoopbackIpcClient.cpp)
set(SRC_CONFIG src/Config/ClientConfigManager.cpp)
set(SRC_MSGQUEUE src/MessageQueue/PersistentMessageQueue.cpp src/MessageQueue/ConnectionMonitor.cpp)
# å¤´æ–‡ä»¶åˆ†ç»„
set(INC_UI include/MainWindow.h include/FileListWidget.h)
set(INC_UPLOAD include/SyncUploadQueue/Lusp_SyncUploadQueue.h src/SyncUploadQueue/Lusp_SyncUploadQueuePrivate.h include/ThreadSafeRowLockQueue/ThreadSafeRowLockQueue.hpp)
set(INC_FILEINFO include/FileInfo/FileInfo.h)
set(INC_HASH 3rdParty/include/hash-library/md5.h)
set(INC_LOOPBACK include/AsioLoopbackIpcClient/Lusp_AsioLoopbackIpcClient.h)
set(INC_CONFIG include/Config/ClientConfigManager.h)
# UIæ–‡ä»¶
set(UI_FILES ui/MainWindow.ui)

# åˆå¹¶æ‰€æœ‰æº/å¤´æ–‡ä»¶ï¼ˆFlatBuffers åªéœ€åŠ  FLATBUFFERS_GENERATED_SOURCESï¼‰
set(ALL_SOURCES ${SRC_MAIN} ${SRC_UI} ${SRC_UPLOAD} ${SRC_FILEINFO} ${SRC_LOG} ${SRC_HASH} ${SRC_LOOPBACK} ${SRC_CONFIG} ${SRC_MSGQUEUE} ${FLATBUFFERS_GENERATED_SOURCES})
set(ALL_HEADERS ${INC_UI} ${INC_UPLOAD} ${INC_FILEINFO} ${INC_HASH} ${INC_LOOPBACK} ${INC_CONFIG})

# includeç›®å½•
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/include/FileInfo
    ${CMAKE_CURRENT_SOURCE_DIR}/include/SyncUploadQueue
    ${CMAKE_CURRENT_SOURCE_DIR}/include/ThreadSafeRowLockQueue
    ${CMAKE_CURRENT_SOURCE_DIR}/include/Config
    ${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include
    ${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include/hash-library
    ${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include/log
    ${CMAKE_CURRENT_SOURCE_DIR}/src/SyncUploadQueue
    ${CMAKE_CURRENT_SOURCE_DIR}/build/_deps/uniconv-src/include
)

# æ·»åŠ æœ¬åœ°toml11å¤´æ–‡ä»¶è·¯å¾„
if(TOML11_LOCAL_AVAILABLE)
    include_directories(${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include)
endif()

# æ·»åŠ æœ¬åœ°magic_enumå¤´æ–‡ä»¶è·¯å¾„
if(MAGIC_ENUM_LOCAL_AVAILABLE)
    include_directories(${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/magic_enum)
endif()

# åŒ…å«ç”Ÿæˆç›®å½•
include_directories(${FBS_GEN_DIR})

# æ·»åŠ  FlatBuffer ç›®å½•åˆ° include è·¯å¾„
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/FlatBuffer)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(UploadClient ${ALL_SOURCES} ${ALL_HEADERS} ${UI_FILES})
add_dependencies(UploadClient FlatBuffersGen)

# ç›®æ ‡includeç›®å½•
target_include_directories(UploadClient PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/include/FileInfo
    ${CMAKE_CURRENT_SOURCE_DIR}/include/SyncUploadQueue
    ${CMAKE_CURRENT_SOURCE_DIR}/include/ThreadSafeRowLockQueue
    ${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include
    ${CMAKE_CURRENT_SOURCE_DIR}/src/SyncUploadQueue
    ${CMAKE_CURRENT_SOURCE_DIR}/build/_deps/uniconv-src/include
)

# FlatBuffers
# æ·»åŠ åˆ°å¯æ‰§è¡Œæ–‡ä»¶
# FlatBuffers å¤´æ–‡ä»¶å·²åŒ…å«åœ¨ INC_FBS

# é“¾æ¥åº“
# FlatBuffers
# Qt6
# abseil
# å…¶ä»–ä¾èµ–

target_link_libraries(UploadClient PRIVATE flatbuffers::flatbuffers)

# åŸºç¡€åº“é“¾æ¥
target_link_libraries(UploadClient PRIVATE
    Qt6::Core
    Qt6::Widgets
    rpcrt4
    Kernel32
)

# Abseilåº“é“¾æ¥ (æœ¬åœ°æºç æ„å»º)
target_link_libraries(UploadClient PRIVATE
    absl::log_severity
    absl::strings
    absl::base
    absl::log
    absl::time
)
if(USING_VCPKG_ABSEIL)
    message(STATUS "âœ… é“¾æ¥ vcpkg Abseil é¢„ç¼–è¯‘åº“ (å¿«é€Ÿ)")
else()
    message(STATUS "âš ï¸ é“¾æ¥æœ¬åœ°æ„å»º Abseil åº“ (è¾ƒæ…¢)")
    message(STATUS "ğŸ’¡ æç¤º: è¿è¡Œ 'vcpkg install abseil:x64-windows' å¯æ˜¾è‘—åŠ é€Ÿåç»­æ„å»º")
endif()

# spdlogåº“é“¾æ¥
target_link_libraries(UploadClient PRIVATE spdlog::spdlog)
message(STATUS "âœ… ä½¿ç”¨spdlogåº“ (FetchContent)")

# UniConvåº“é“¾æ¥
target_link_libraries(UploadClient PRIVATE UniConv::UniConv)
message(STATUS "âœ… ä½¿ç”¨UniConvåº“ (FetchContent)")

# é…ç½®TOMLåº“
if(TOML11_LOCAL_AVAILABLE)
    target_include_directories(UploadClient PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/include)
    target_compile_definitions(UploadClient PRIVATE TOML11_AVAILABLE)
    message(STATUS "âœ… ä½¿ç”¨æœ¬åœ°toml11åº“: ${TOML11_LOCAL_PATH}")
else()
    message(WARNING "âš ï¸ toml11 not found. TOML configuration features will be limited.")
    target_compile_definitions(UploadClient PRIVATE NO_TOML_SUPPORT)
endif()

# é…ç½®magic_enumåº“
if(MAGIC_ENUM_LOCAL_AVAILABLE)
    target_include_directories(UploadClient PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/3rdParty/magic_enum)
    target_compile_definitions(UploadClient PRIVATE MAGIC_ENUM_AVAILABLE)
    message(STATUS "âœ… ä½¿ç”¨æœ¬åœ°magic_enumåº“: ${MAGIC_ENUM_LOCAL_PATH}")
else()
    message(WARNING "âš ï¸ magic_enum not found. Enum reflection features will be limited.")
    target_compile_definitions(UploadClient PRIVATE NO_MAGIC_ENUM_SUPPORT)
endif()

# è¾“å‡ºç›®å½•
set_target_properties(UploadClient PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
)

set_target_properties(UploadClient PROPERTIES LINK_FLAGS "/SUBSYSTEM:CONSOLE")

# Windowsç‰¹å®šè®¾ç½®
if(WIN32)
    set_target_properties(UploadClient PROPERTIES WIN32_EXECUTABLE TRUE)
endif()

# ç¼–è¯‘å™¨ç‰¹å®šè®¾ç½®
if(MSVC)
    target_compile_options(UploadClient PRIVATE /W3)
    target_compile_definitions(UploadClient PRIVATE UNICODE _UNICODE _CRT_SECURE_NO_WARNINGS)
    # MSVC: å¼ºåˆ¶ __cplusplus å®æ­£ç¡®
    add_compile_options(/Zc:__cplusplus)
    add_definitions(-D_WIN32_WINNT=0x0601)
else()
    target_compile_options(UploadClient PRIVATE -Wall -Wextra)
endif()

# è°ƒè¯•ä¿¡æ¯
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_compile_definitions(UploadClient PRIVATE DEBUG)
endif()

# è¾“å‡ºæ„å»ºä¿¡æ¯
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Qt6 Version: ${Qt6_VERSION}")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID}")
message(STATUS "Sources: ${ALL_SOURCES}")
message(STATUS "Headers: ${ALL_HEADERS}")
