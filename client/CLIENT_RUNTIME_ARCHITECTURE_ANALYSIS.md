# å®¢æˆ·ç«¯è¿è¡Œæ—¶æ¶æ„åˆ†æ

## ğŸ“‹ æ–‡æ¡£ç›®æ ‡

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æé«˜æ€§èƒ½æ–‡ä»¶ä¸Šä¼ å®¢æˆ·ç«¯çš„**è¿è¡Œæ—¶æ¶æ„**ï¼Œè¯¦ç»†è§£é‡Šä»ç¨‹åºå¯åŠ¨åˆ°æ–‡ä»¶ä¸Šä¼ çš„å®Œæ•´æ‰§è¡Œæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š
- åˆå§‹åŒ–ä¸å¯åŠ¨æµç¨‹
- çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ•°æ®æµè½¬ä¸çŠ¶æ€è½¬æ¢
- å†…å­˜ç®¡ç†ä¸èµ„æºé‡Šæ”¾
- æ€§èƒ½ç‰¹å¾ä¸ç“¶é¢ˆåˆ†æ

## ğŸš€ ç¨‹åºå¯åŠ¨æµç¨‹

### 1. å¯åŠ¨é˜¶æ®µæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    main() å…¥å£å‡½æ•°                           â”‚
â”‚  1. QApplicationåˆå§‹åŒ–                                       â”‚
â”‚  2. æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–                                           â”‚
â”‚  3. é…ç½®ç®¡ç†å™¨åŠ è½½                                           â”‚
â”‚  4. å…¨å±€å•ä¾‹åˆ›å»º                                             â”‚
â”‚  5. é€šçŸ¥æœåŠ¡å¯åŠ¨                                             â”‚
â”‚  6. UIä¸»çª—å£åˆ›å»º                                             â”‚
â”‚  7. Qtäº‹ä»¶å¾ªç¯å¯åŠ¨                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¿è¡Œæ—¶ä¸‰å±‚æ¶æ„ï¼ˆå·²å¯åŠ¨ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UIä¸»çº¿ç¨‹ (Qt Event Loop)                                   â”‚
â”‚  - å¤„ç†ç”¨æˆ·äº¤äº’                                             â”‚
â”‚  - å“åº”æ‹–æ‹½/ç‚¹å‡»äº‹ä»¶                                        â”‚
â”‚  - è°ƒç”¨ queue.push() å…¥é˜Ÿæ–‡ä»¶                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€šçŸ¥çº¿ç¨‹ (Background Thread)                               â”‚
â”‚  - ç‹¬ç«‹std::threadè¿è¡Œ                                      â”‚
â”‚  - é˜»å¡ç­‰å¾…é˜Ÿåˆ—æ•°æ® (waitAndPop)                            â”‚
â”‚  - é€šè¿‡IPCå‘é€æ–‡ä»¶ä¿¡æ¯                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœ¬åœ°æœåŠ¡å±‚ (External Process)                              â”‚
â”‚  - é€šè¿‡Loopback Socketæ¥æ”¶é€šçŸ¥                              â”‚
â”‚  - åå°æ‰§è¡ŒçœŸæ­£çš„ä¸Šä¼ é€»è¾‘                                    â”‚
â”‚  - å›è°ƒè¿›åº¦ä¿¡æ¯åˆ°UI                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è¯¦ç»†å¯åŠ¨æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Main as main()
    participant QApp as QApplication
    participant Log as æ—¥å¿—ç³»ç»Ÿ
    participant Config as é…ç½®ç®¡ç†å™¨
    participant Queue as ä¸Šä¼ é˜Ÿåˆ—å•ä¾‹
    participant NotifyService as é€šçŸ¥æœåŠ¡
    participant UI as MainWindow
    
    Main->>QApp: åˆ›å»º QApplication
    Main->>Log: initializeLogging()
    Log-->>Main: æ—¥å¿—ç³»ç»Ÿå°±ç»ª
    
    Main->>Config: loadFromFile("config/upload_client.toml")
    Config-->>Main: é…ç½®åŠ è½½å®Œæˆ
    
    Main->>Queue: Lusp_SyncUploadQueue::instance()
    Note over Queue: å…¨å±€å•ä¾‹é¦–æ¬¡åˆ›å»º<br/>ThreadSafeRowLockQueueåˆå§‹åŒ–
    Queue-->>Main: è¿”å›é˜Ÿåˆ—å¼•ç”¨
    
    Main->>NotifyService: åˆ›å»º NotificationService(queue, config)
    Note over NotifyService: å†…éƒ¨åˆ›å»º io_context<br/>åˆå§‹åŒ– IPCå®¢æˆ·ç«¯<br/>è®¾ç½®FlatBuffersåºåˆ—åŒ–
    NotifyService-->>Main: æœåŠ¡åˆ›å»ºå®Œæˆ
    
    Main->>NotifyService: start()
    Note over NotifyService: å¯åŠ¨é€šçŸ¥çº¿ç¨‹<br/>å¼€å§‹ç›‘å¬é˜Ÿåˆ—
    
    Main->>UI: åˆ›å»º MainWindow
    UI-->>Main: çª—å£åˆ›å»ºå®Œæˆ
    
    Main->>UI: show()
    Note over UI: æ˜¾ç¤ºä¸»çª—å£
    
    Main->>QApp: exec()
    Note over QApp,UI: è¿›å…¥Qtäº‹ä»¶å¾ªç¯<br/>ç­‰å¾…ç”¨æˆ·äº¤äº’
```

### 3. å…³é”®åˆå§‹åŒ–ä»£ç åˆ†æ

```cpp
// main.cpp - å¯åŠ¨æµç¨‹
int main(int argc, char* argv[]) {
    // ç¬¬1æ­¥ï¼šåˆ›å»ºQtåº”ç”¨ç¨‹åºå®ä¾‹
    QApplication app(argc, argv);
    
    // ç¬¬2æ­¥ï¼šåˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿï¼ˆå…¨å±€Loggerå¯¹è±¡ï¼‰
    initializeLogging();
    
    // ç¬¬3æ­¥ï¼šåŠ è½½é…ç½®æ–‡ä»¶
    auto& cfgMgr = ClientConfigManager::getInstance();
    cfgMgr.loadFromFile("./config/upload_client.toml");
    
    // ç¬¬4æ­¥ï¼šåˆ›å»ºå…¨å±€ä¸Šä¼ é˜Ÿåˆ—å•ä¾‹ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
    // å•ä¾‹æ¨¡å¼ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨instance()æ—¶åˆ›å»º
    Lusp_SyncUploadQueue& queue = Lusp_SyncUploadQueue::instance();
    
    // ç¬¬5æ­¥ï¼šåˆ›å»ºå¹¶å¯åŠ¨é€šçŸ¥æœåŠ¡ï¼ˆæ™ºèƒ½æŒ‡é’ˆç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼‰
    std::unique_ptr<Lusp_SyncFilesNotificationService> notifier = 
        std::make_unique<Lusp_SyncFilesNotificationService>(queue, cfgMgr);
    notifier->start();  // å¯åŠ¨ç‹¬ç«‹é€šçŸ¥çº¿ç¨‹
    
    // ç¬¬6æ­¥ï¼šåˆ›å»ºä¸»çª—å£
    MainWindow window;
    window.show();
    
    // ç¬¬7æ­¥ï¼šè¿›å…¥Qtäº‹ä»¶å¾ªç¯
    int ret = app.exec();
    
    // ç¬¬8æ­¥ï¼šæ¸…ç†é˜¶æ®µï¼ˆç¨‹åºé€€å‡ºæ—¶ï¼‰
    notifier->stop();   // åœæ­¢é€šçŸ¥çº¿ç¨‹
    notifier.reset();   // é‡Šæ”¾èµ„æº
    
    return ret;
}
```

**å…³é”®ç‚¹åˆ†æ**ï¼š
1. **QApplicationå¿…é¡»æœ€å…ˆåˆ›å»º**ï¼šQtè¦æ±‚åœ¨ä»»ä½•Qtå¯¹è±¡ä¹‹å‰åˆ›å»º
2. **å•ä¾‹æ¨¡å¼å»¶è¿Ÿåˆå§‹åŒ–**ï¼š`Lusp_SyncUploadQueue::instance()`é¦–æ¬¡è°ƒç”¨æ—¶åˆ›å»º
3. **æ™ºèƒ½æŒ‡é’ˆç®¡ç†ç”Ÿå‘½å‘¨æœŸ**ï¼š`std::unique_ptr`è‡ªåŠ¨ç®¡ç†NotificationService
4. **é€šçŸ¥çº¿ç¨‹ç‹¬ç«‹è¿è¡Œ**ï¼š`notifier->start()`åç«‹å³è¿”å›ï¼Œçº¿ç¨‹åœ¨åå°å·¥ä½œ
5. **Qtäº‹ä»¶å¾ªç¯é˜»å¡ä¸»çº¿ç¨‹**ï¼š`app.exec()`ç›´åˆ°çª—å£å…³é—­æ‰è¿”å›

## ğŸ§µ çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 1. ä¸‰çº¿ç¨‹è¿è¡Œæ—¶æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¿›ç¨‹åœ°å€ç©ºé—´                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¨ çº¿ç¨‹1: UIä¸»çº¿ç¨‹ (Qt Event Loop)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”Ÿå‘½å‘¨æœŸ: ä»main()åˆ°app.exec()è¿”å›                     â”‚  â”‚
â”‚  â”‚ èŒè´£: å¤„ç†UIäº‹ä»¶ã€æ–‡ä»¶å…¥é˜Ÿ                             â”‚  â”‚
â”‚  â”‚ é˜»å¡ç‚¹: QApplication::exec()                          â”‚  â”‚
â”‚  â”‚ å…³é”®æ“ä½œ: queue.push() - éé˜»å¡ï¼Œç«‹å³è¿”å›              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“ é€šè¿‡ThreadSafeRowLockQueueé€šä¿¡    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ§µ çº¿ç¨‹2: é€šçŸ¥çº¿ç¨‹ (Background Notification Thread)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”Ÿå‘½å‘¨æœŸ: notifier->start() åˆ° notifier->stop()        â”‚  â”‚
â”‚  â”‚ èŒè´£: ç›‘å¬é˜Ÿåˆ—ã€IPCé€šä¿¡                               â”‚  â”‚
â”‚  â”‚ é˜»å¡ç‚¹: uploadQueue.waitAndPop() - æ¡ä»¶å˜é‡ç­‰å¾…       â”‚  â”‚
â”‚  â”‚ å…³é”®æ“ä½œ: ipcClient->send() - å‘é€FlatBuffersæ•°æ®     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“ é€šè¿‡Loopback Socketé€šä¿¡          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”„ çº¿ç¨‹3: ASIO IOçº¿ç¨‹ (io_contextè¿è¡Œçº¿ç¨‹)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”Ÿå‘½å‘¨æœŸ: ioThread_å¯åŠ¨ åˆ° ioContext_->stop()          â”‚  â”‚
â”‚  â”‚ èŒè´£: å¤„ç†å¼‚æ­¥Socket I/O                              â”‚  â”‚
â”‚  â”‚ é˜»å¡ç‚¹: ioContext_->run() - ç­‰å¾…å¼‚æ­¥äº‹ä»¶              â”‚  â”‚
â”‚  â”‚ å…³é”®æ“ä½œ: å¼‚æ­¥send/recv Socketæ•°æ®                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é€šçŸ¥çº¿ç¨‹è¯¦ç»†åˆ†æ

```cpp
// NotificationServiceæ„é€ å‡½æ•°ï¼šå¯åŠ¨IOçº¿ç¨‹å’Œé€šçŸ¥çº¿ç¨‹
Lusp_SyncFilesNotificationService::Lusp_SyncFilesNotificationService(
    Lusp_SyncUploadQueue& queue, 
    const ClientConfigManager& configMgr)
    : queueRef(queue), configMgr_(&configMgr) {
    
    // 1. åˆ›å»ºio_contextå’ŒIPCå®¢æˆ·ç«¯
    ioContext_ = std::make_shared<asio::io_context>();
    ipcClient_ = std::make_shared<Lusp_AsioLoopbackIpcClient>(*ioContext_, configMgr);
    ipcClient_->connect();
    
    // 2. è®¾ç½®åºåˆ—åŒ–å›è°ƒå‡½æ•°
    setSocketSendFunc([this](const Lusp_SyncUploadFileInfo& info) {
        std::string fbData = ToFlatBuffer(info);  // åºåˆ—åŒ–ä¸ºFlatBuffers
        if (ipcClient_) {
            ipcClient_->send(fbData);  // é€šè¿‡IPCå‘é€
        }
    });
    
    // 3. å¯åŠ¨IOçº¿ç¨‹ï¼ˆç®¡ç†å¼‚æ­¥Socketæ“ä½œï¼‰
    ioThread_ = std::thread([this]() { 
        ioContext_->run();  // é˜»å¡è¿è¡Œï¼Œå¤„ç†å¼‚æ­¥äº‹ä»¶
    });
}

// å¯åŠ¨é€šçŸ¥çº¿ç¨‹
void Lusp_SyncFilesNotificationService::start() {
    shouldStop = false;
    notifyThread = std::thread([this]() { 
        notificationLoop();  // çº¿ç¨‹ä¸»å¾ªç¯
    });
}

// é€šçŸ¥çº¿ç¨‹ä¸»å¾ªç¯
void Lusp_SyncFilesNotificationService::notificationLoop() {
    while (!shouldStop) {
        Lusp_SyncUploadFileInfo fileInfo;
        
        // å…³é”®é˜»å¡ç‚¹ï¼šç­‰å¾…é˜Ÿåˆ—æœ‰æ•°æ®ï¼ˆæ¡ä»¶å˜é‡ï¼‰
        if (queueRef.d && queueRef.d->uploadQueue.waitAndPop(fileInfo)) {
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å“¨å…µå¯¹è±¡ï¼ˆç”¨äºå”¤é†’çº¿ç¨‹é€€å‡ºï¼‰
            if (shouldStop || fileInfo.sFileFullNameValue.empty()) {
                break;
            }
            
            // ç»Ÿè®¡å»¶è¿Ÿ
            auto now = std::chrono::steady_clock::now();
            double latency = std::chrono::duration<double, std::milli>(
                now - fileInfo.enqueueTime).count();
            
            {
                std::unique_lock<std::mutex> lock(latencyMutex);
                totalLatencyMs += latency;
            }
            processedCount++;
            
            // è°ƒç”¨å›è°ƒå‡½æ•°ï¼ˆåºåˆ—åŒ–å¹¶å‘é€ï¼‰
            if (socketSendFunc) {
                socketSendFunc(fileInfo);
            }
            
            // æ—¥å¿—è®°å½•
            g_LogSyncNotificationService.WriteLogContent(LOG_INFO, 
                "é€šè¿‡socketå‘é€: " + fileInfo.sFileFullNameValue);
        }
    }
}

// åœæ­¢çº¿ç¨‹ï¼ˆå®‰å…¨é€€å‡ºï¼‰
void Lusp_SyncFilesNotificationService::stop() {
    shouldStop = true;
    
    // æ–¹æ¡ˆAï¼špushå“¨å…µå¯¹è±¡å”¤é†’waitAndPop()
    if (queueRef.d) {
        Lusp_SyncUploadFileInfo dummy;  // ç©ºå¯¹è±¡ä½œä¸ºå“¨å…µ
        queueRef.d->uploadQueue.push(dummy);
    }
    
    // ç­‰å¾…çº¿ç¨‹å®‰å…¨é€€å‡º
    if (notifyThread.joinable()) {
        notifyThread.join();
    }
}
```

**å…³é”®çº¿ç¨‹åŒæ­¥æœºåˆ¶**ï¼š
1. **æ¡ä»¶å˜é‡å”¤é†’**ï¼š`waitAndPop()`ä½¿ç”¨`std::condition_variable`é˜»å¡ç­‰å¾…
2. **å“¨å…µå¯¹è±¡æ¨¡å¼**ï¼š`stop()`æ—¶pushç©ºå¯¹è±¡å”¤é†’çº¿ç¨‹ï¼Œé¿å…æ­»é”
3. **åŸå­è®¡æ•°å™¨**ï¼š`processedCount`ä½¿ç”¨`std::atomic<size_t>`ï¼Œæ— é”ç»Ÿè®¡
4. **äº’æ–¥é”ä¿æŠ¤**ï¼š`latencyMutex`ä¿æŠ¤`totalLatencyMs`ç´¯åŠ æ“ä½œ

### 3. çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº

```
UIä¸»çº¿ç¨‹çŠ¶æ€è½¬æ¢:
[åˆ›å»º] â†’ [è¿è¡Œ(äº‹ä»¶å¾ªç¯)] â†’ [é€€å‡º(app.execè¿”å›)] â†’ [æ¸…ç†]
         â†‘_______________|
         Qtäº‹ä»¶é©±åŠ¨å¾ªç¯

é€šçŸ¥çº¿ç¨‹çŠ¶æ€è½¬æ¢:
[æœªå¯åŠ¨] â†’ [å¯åŠ¨(start)] â†’ [ç­‰å¾…é˜Ÿåˆ—] â‡„ [å¤„ç†æ•°æ®] â†’ [åœæ­¢ä¿¡å·] â†’ [é€€å‡º]
                          â†‘_______________|              â†“
                          æ¡ä»¶å˜é‡é˜»å¡                  pushå“¨å…µå”¤é†’

IOçº¿ç¨‹çŠ¶æ€è½¬æ¢:
[åˆ›å»º] â†’ [è¿è¡Œ(io_context::run)] â†’ [åœæ­¢(ioContext->stop)] â†’ [é€€å‡º]
         â†‘___________________|
         å¤„ç†å¼‚æ­¥Socketäº‹ä»¶
```

## ğŸ“Š æ•°æ®æµè½¬ä¸çŠ¶æ€è½¬æ¢

### 1. å®Œæ•´æ•°æ®æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ“ä½œè§¦å‘                               â”‚
â”‚  æ‹–æ‹½æ–‡ä»¶ / ç‚¹å‡»æŒ‰é’® / è°ƒç”¨API                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UIçº¿ç¨‹ï¼šæ–‡ä»¶å…¥é˜Ÿ (< 1Î¼s)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. æ£€æµ‹æ–‡ä»¶è·¯å¾„                                        â”‚  â”‚
â”‚  â”‚ 2. æ„é€  Lusp_SyncUploadFileInfo ç»“æ„ä½“                â”‚  â”‚
â”‚  â”‚    - sFileFullNameValue: æ–‡ä»¶å…¨è·¯å¾„                   â”‚  â”‚
â”‚  â”‚    - sSyncFileSizeValue: æ–‡ä»¶å¤§å°                     â”‚  â”‚
â”‚  â”‚    - enqueueTime: å½“å‰æ—¶é—´æˆ³                          â”‚  â”‚
â”‚  â”‚ 3. è°ƒç”¨ uploadQueue.push(fileInfo)                    â”‚  â”‚
â”‚  â”‚    â†’ è·å– mEnqueueMutex                               â”‚  â”‚
â”‚  â”‚    â†’ mDataQueue.push(fileInfo)                        â”‚  â”‚
â”‚  â”‚    â†’ mSize.fetch_add(1)                               â”‚  â”‚
â”‚  â”‚    â†’ é‡Šæ”¾é”                                            â”‚  â”‚
â”‚  â”‚    â†’ mWorkCV.notify_one()  // å”¤é†’é€šçŸ¥çº¿ç¨‹            â”‚  â”‚
â”‚  â”‚ 4. ç«‹å³è¿”å›ï¼ŒUIç»§ç»­å“åº”                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (é€šè¿‡æ¡ä»¶å˜é‡å”¤é†’)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šçŸ¥çº¿ç¨‹ï¼šæ•°æ®å‡ºé˜Ÿä¸å¤„ç† (~ 1-10ms)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. waitAndPop()è¢«æ¡ä»¶å˜é‡å”¤é†’                          â”‚  â”‚
â”‚  â”‚    â†’ è·å– mDequeueMutex                               â”‚  â”‚
â”‚  â”‚    â†’ mDataQueue.pop()                                 â”‚  â”‚
â”‚  â”‚    â†’ mSize.fetch_sub(1)                               â”‚  â”‚
â”‚  â”‚    â†’ é‡Šæ”¾é”                                            â”‚  â”‚
â”‚  â”‚ 2. è®¡ç®—é˜Ÿåˆ—å»¶è¿Ÿ (now - enqueueTime)                   â”‚  â”‚
â”‚  â”‚ 3. åºåˆ—åŒ–ä¸ºFlatBuffersæ ¼å¼                             â”‚  â”‚
â”‚  â”‚    â†’ ToFlatBuffer(fileInfo)                           â”‚  â”‚
â”‚  â”‚    â†’ ç”ŸæˆäºŒè¿›åˆ¶å­—èŠ‚æµ                                  â”‚  â”‚
â”‚  â”‚ 4. é€šè¿‡IPCå‘é€åˆ°æœ¬åœ°æœåŠ¡                               â”‚  â”‚
â”‚  â”‚    â†’ ipcClient_->send(fbData)                         â”‚  â”‚
â”‚  â”‚    â†’ å¼‚æ­¥å†™å…¥Socket                                    â”‚  â”‚
â”‚  â”‚ 5. æ›´æ–°ç»Ÿè®¡æ•°æ®                                        â”‚  â”‚
â”‚  â”‚    â†’ processedCount++                                 â”‚  â”‚
â”‚  â”‚    â†’ totalLatencyMs += latency                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (é€šè¿‡Loopback Socket)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°æœåŠ¡å±‚ï¼šæ¥æ”¶å¹¶ä¸Šä¼  (å¤–éƒ¨è¿›ç¨‹)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Socketæ¥æ”¶FlatBuffersæ•°æ®                           â”‚  â”‚
â”‚  â”‚ 2. ååºåˆ—åŒ–ä¸ºæ–‡ä»¶ä¿¡æ¯ç»“æ„                               â”‚  â”‚
â”‚  â”‚ 3. åŠ å…¥ä¸Šä¼ é˜Ÿåˆ—ï¼ˆæœ¬åœ°æœåŠ¡å†…éƒ¨é˜Ÿåˆ—ï¼‰                     â”‚  â”‚
â”‚  â”‚ 4. åå°çº¿ç¨‹æ‰§è¡Œä¸Šä¼                                     â”‚  â”‚
â”‚  â”‚    â†’ æ‰“å¼€æ–‡ä»¶                                          â”‚  â”‚
â”‚  â”‚    â†’ åˆ†å—è¯»å–                                          â”‚  â”‚
â”‚  â”‚    â†’ ç½‘ç»œå‘é€                                          â”‚  â”‚
â”‚  â”‚ 5. æ¯ç§’å›è°ƒè¿›åº¦åˆ°UIï¼ˆå¯é€‰ï¼‰                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®ç»“æ„è½¬æ¢æµç¨‹

```cpp
// é˜¶æ®µ1ï¼šUIæ„é€ æ–‡ä»¶ä¿¡æ¯
struct Lusp_SyncUploadFileInfo {
    Lusp_UploadFileTyped eUploadFileTyped;     // æ–‡ä»¶ç±»å‹æšä¸¾
    std::u16string sLanClientDevice;           // å®¢æˆ·ç«¯è®¾å¤‡ID
    size_t sSyncFileSizeValue;                 // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    std::u16string sFileFullNameValue;         // æ–‡ä»¶å…¨è·¯å¾„ï¼ˆUTF-16LEï¼‰
    std::u16string sOnlyFileNameValue;         // ä»…æ–‡ä»¶å
    std::string sFileRecordTimeValue;          // è®°å½•æ—¶é—´
    std::string sFileMd5ValueInfo;             // MD5æ ¡éªŒå€¼
    Lusp_FileExistPolicy eFileExistPolicy;     // æ–‡ä»¶å­˜åœ¨ç­–ç•¥
    std::string sAuthTokenValues;              // è®¤è¯ä»¤ç‰Œ
    uint32_t uUploadTimeStamp;                 // ä¸Šä¼ æ—¶é—´æˆ³
    Lusp_UploadStatusInf eUploadStatusInf;     // ä¸Šä¼ çŠ¶æ€
    std::u16string sDescriptionInfo;           // æè¿°ä¿¡æ¯
    std::chrono::steady_clock::time_point enqueueTime; // å…¥é˜Ÿæ—¶é—´
};

// é˜¶æ®µ2ï¼šåºåˆ—åŒ–ä¸ºFlatBuffers
std::string ToFlatBuffer(const Lusp_SyncUploadFileInfo& info) {
    flatbuffers::FlatBufferBuilder builder;
    
    // UTF-16LE â†’ UTF-8 è½¬æ¢
    auto s_file_full_name = builder.CreateString(
        UniConv::GetInstance()->ToUtf8FromUtf16LE(info.sFileFullNameValue));
    
    // æ„é€ FlatBufferså¯¹è±¡
    auto fb = CreateFBS_SyncUploadFileInfo(
        builder,
        static_cast<FBS_SyncUploadFileTyped>(info.eUploadFileTyped),
        ...,
        s_file_full_name,
        ...,
        static_cast<uint64_t>(
            std::chrono::duration_cast<std::chrono::milliseconds>(
                info.enqueueTime.time_since_epoch()).count())
    );
    
    builder.Finish(fb);
    
    // è¿”å›äºŒè¿›åˆ¶å­—èŠ‚æµ
    return std::string(
        reinterpret_cast<const char*>(builder.GetBufferPointer()), 
        builder.GetSize());
}

// é˜¶æ®µ3ï¼šæœ¬åœ°æœåŠ¡ååºåˆ—åŒ–
Lusp_SyncUploadFileInfo FromFlatBuffer(const uint8_t* buf, size_t size) {
    auto fb = GetFBS_SyncUploadFileInfo(buf);
    
    Lusp_SyncUploadFileInfo info{};
    info.sFileFullNameValue = UniConv::GetInstance()->ToUtf16LEFromLocale(
        fb->s_file_full_name_value()->str());
    info.sSyncFileSizeValue = fb->s_sync_file_size_value();
    // ...å…¶ä»–å­—æ®µæ˜ å°„
    info.enqueueTime = std::chrono::steady_clock::time_point(
        std::chrono::milliseconds(fb->enqueue_time_ms()));
    
    return info;
}
```

**æ•°æ®è½¬æ¢å…³é”®ç‚¹**ï¼š
1. **UTF-16LE â†” UTF-8**ï¼šWindowsæ–‡ä»¶è·¯å¾„ä½¿ç”¨UTF-16LEï¼Œéœ€è¦è½¬æ¢
2. **æšä¸¾ç±»å‹è½¬æ¢**ï¼šC++æšä¸¾ â†’ FlatBuffersæšä¸¾ï¼ˆå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼‰
3. **æ—¶é—´æˆ³è½¬æ¢**ï¼š`std::chrono::time_point` â†’ æ¯«ç§’uint64_t
4. **é›¶æ‹·è´åºåˆ—åŒ–**ï¼šFlatBuffersç›´æ¥æ“ä½œå†…å­˜ï¼Œé¿å…å¤šæ¬¡æ‹·è´

### 3. çŠ¶æ€è½¬æ¢å›¾

```
æ–‡ä»¶ä¸Šä¼ çŠ¶æ€æœº:
[å…¥é˜Ÿ] â†’ [ç­‰å¾…å¤„ç†] â†’ [åºåˆ—åŒ–] â†’ [IPCå‘é€] â†’ [æœ¬åœ°æœåŠ¡æ¥æ”¶] â†’ [ä¸Šä¼ ä¸­] â†’ [å®Œæˆ/å¤±è´¥]
  â†“          â†“            â†“          â†“              â†“
enqueue   waitAndPop  ToFlatBuffer  send      ååºåˆ—åŒ–
(UIçº¿ç¨‹)  (é€šçŸ¥çº¿ç¨‹)  (é€šçŸ¥çº¿ç¨‹)   (IOçº¿ç¨‹)  (æœ¬åœ°æœåŠ¡)

é˜Ÿåˆ—å¤§å°å˜åŒ–:
mSize = 0 â†’ push() â†’ mSize++ â†’ notify_one() â†’ waitAndPop() â†’ mSize-- â†’ mSize = 0
         (UIçº¿ç¨‹)              (å”¤é†’)        (é€šçŸ¥çº¿ç¨‹)
```

## ğŸ”’ è¡Œçº§é”é˜Ÿåˆ—æ·±åº¦åˆ†æ

### 1. ThreadSafeRowLockQueue å†…éƒ¨ç»“æ„

```cpp
template<typename T>
class ThreadSafeRowLockQueue {
private:
    mutable std::mutex mEnqueueMutex;    // å…¥é˜Ÿä¸“ç”¨é”ï¼ˆUIçº¿ç¨‹ï¼‰
    mutable std::mutex mDequeueMutex;    // å‡ºé˜Ÿä¸“ç”¨é”ï¼ˆé€šçŸ¥çº¿ç¨‹ï¼‰
    std::queue<T> mDataQueue;            // åº•å±‚æ ‡å‡†é˜Ÿåˆ—
    std::condition_variable mWorkCV;     // æ¡ä»¶å˜é‡ï¼ˆå”¤é†’æœºåˆ¶ï¼‰
    std::atomic<size_t> mSize{0};        // åŸå­è®¡æ•°å™¨ï¼ˆæ— é”æŸ¥è¯¢ï¼‰
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **åŒé”åˆ†ç¦»**ï¼š`mEnqueueMutex`å’Œ`mDequeueMutex`å®Œå…¨ç‹¬ç«‹ï¼ŒUIå’Œé€šçŸ¥çº¿ç¨‹ä¸äº’ç›¸é˜»å¡
- **æ¡ä»¶å˜é‡**ï¼š`mWorkCV`ç²¾ç¡®å”¤é†’ï¼Œé¿å…å¿™ç­‰å¾…ï¼ˆbusy-waitï¼‰
- **åŸå­è®¡æ•°å™¨**ï¼š`mSize`ä½¿ç”¨`std::atomic`ï¼Œ`size()`å’Œ`empty()`æ— é”æŸ¥è¯¢

### 2. å…¥é˜Ÿæ“ä½œè¯¦ç»†åˆ†æ

```cpp
void push(const T& item) {
    {  // RAIIä½œç”¨åŸŸï¼šè‡ªåŠ¨é”ç®¡ç†
        std::unique_lock<std::mutex> lock(mEnqueueMutex);
        mDataQueue.push(item);           // æ ‡å‡†é˜Ÿåˆ—push
        mSize.fetch_add(1);              // åŸå­é€’å¢ï¼ŒReleaseè¯­ä¹‰
    }  // é”è‡ªåŠ¨é‡Šæ”¾
    
    mWorkCV.notify_one();  // å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ˆä¸éœ€è¦æŒæœ‰é”ï¼‰
}
```

**æ‰§è¡Œæ—¶åºåˆ†æ**ï¼š
```
æ—¶åˆ»T0: UIçº¿ç¨‹è°ƒç”¨ queue.push(fileInfo)
æ—¶åˆ»T1: å°è¯•è·å– mEnqueueMutex (å¯èƒ½é˜»å¡ï¼Œä½†æçŸ­)
æ—¶åˆ»T2: è·å–é”æˆåŠŸï¼Œæ‰§è¡Œ mDataQueue.push(item) (< 100ns)
æ—¶åˆ»T3: æ‰§è¡Œ mSize.fetch_add(1) (< 50nsï¼ŒåŸå­æ“ä½œ)
æ—¶åˆ»T4: é‡Šæ”¾ mEnqueueMutex (RAIIè‡ªåŠ¨é‡Šæ”¾)
æ—¶åˆ»T5: è°ƒç”¨ mWorkCV.notify_one() (< 1Î¼sï¼Œå”¤é†’é€šçŸ¥çº¿ç¨‹)
æ—¶åˆ»T6: push()è¿”å›ï¼ŒUIç»§ç»­å·¥ä½œ

æ€»è€—æ—¶: T6 - T0 â‰ˆ 1-10Î¼s (å¾®ç§’çº§)
```

**æ€§èƒ½ç‰¹å¾**ï¼š
- **éé˜»å¡è®¾è®¡**ï¼šå³ä½¿é€šçŸ¥çº¿ç¨‹æ­£åœ¨`waitAndPop()`ï¼ŒUIçº¿ç¨‹ä¹Ÿä¸ä¼šé˜»å¡
- **æä½å»¶è¿Ÿ**ï¼šæ•´ä¸ªpushæ“ä½œåœ¨å¾®ç§’çº§å®Œæˆ
- **æ— é”ç«äº‰**ï¼šå…¥é˜Ÿé”å’Œå‡ºé˜Ÿé”åˆ†ç¦»ï¼Œå¹¶å‘æ€§èƒ½ä¼˜å¼‚

### 3. å‡ºé˜Ÿæ“ä½œè¯¦ç»†åˆ†æ

```cpp
bool waitAndPop(T& item) {
    std::unique_lock<std::mutex> lock(mDequeueMutex);
    
    // æ¡ä»¶å˜é‡ç­‰å¾…ï¼šé‡Šæ”¾é”å¹¶é˜»å¡ï¼Œç›´åˆ°è¢«notify_one()å”¤é†’
    mWorkCV.wait(lock, [this] { 
        return mSize.load() > 0;  // åŸå­è¯»å–ï¼ŒAcquireè¯­ä¹‰
    });
    
    if (!mDataQueue.empty()) {
        item = std::move(mDataQueue.front());  // ç§»åŠ¨è¯­ä¹‰ï¼Œé¿å…æ‹·è´
        mDataQueue.pop();
        mSize.fetch_sub(1);  // åŸå­é€’å‡
        return true;
    }
    return false;
}
```

**æ‰§è¡Œæ—¶åºåˆ†æ**ï¼š
```
æ—¶åˆ»T0: é€šçŸ¥çº¿ç¨‹è°ƒç”¨ waitAndPop(fileInfo)
æ—¶åˆ»T1: è·å– mDequeueMutex
æ—¶åˆ»T2: æ‰§è¡Œ mWorkCV.wait()
    - æ£€æŸ¥è°“è¯ mSize.load() > 0
    - å¦‚æœä¸ºfalseï¼Œé‡Šæ”¾é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆé˜»å¡ï¼‰
    - å¦‚æœä¸ºtrueï¼Œç«‹å³è¿”å›ï¼ˆé”ä»æŒæœ‰ï¼‰
æ—¶åˆ»T3: è¢« notify_one() å”¤é†’
æ—¶åˆ»T4: é‡æ–°è·å–é”ï¼Œå†æ¬¡æ£€æŸ¥è°“è¯
æ—¶åˆ»T5: è°“è¯ä¸ºtrueï¼Œæ‰§è¡Œ mDataQueue.pop()
æ—¶åˆ»T6: æ‰§è¡Œ mSize.fetch_sub(1)
æ—¶åˆ»T7: é‡Šæ”¾é”å¹¶è¿”å›true

é˜»å¡æ—¶é—´: T3 - T2 (å–å†³äºé˜Ÿåˆ—ä½•æ—¶æœ‰æ•°æ®)
å¤„ç†æ—¶é—´: T7 - T3 â‰ˆ 1-10Î¼s
```

**æ¡ä»¶å˜é‡æœºåˆ¶**ï¼š
```cpp
// wait()å†…éƒ¨ä¼ªä»£ç 
void condition_variable::wait(unique_lock& lock, Predicate pred) {
    while (!pred()) {  // å¾ªç¯æ£€æŸ¥è°“è¯ï¼Œé˜²æ­¢è™šå‡å”¤é†’
        unlock(lock);          // é‡Šæ”¾é”
        block_until_notified(); // é˜»å¡ç­‰å¾…notify
        lock(lock);            // é‡æ–°è·å–é”
    }
}
```

### 4. æ— é”æŸ¥è¯¢æ“ä½œ

```cpp
size_t size() const {
    return mSize.load();  // åŸå­è¯»å–ï¼Œæ— éœ€é”
}

bool empty() const {
    return mSize.load() == 0;  // åŸå­è¯»å–ï¼Œæ— éœ€é”
}
```

**åŸå­æ“ä½œå†…å­˜é¡ºåº**ï¼š
- `fetch_add(1)`ä½¿ç”¨**Releaseè¯­ä¹‰**ï¼šç¡®ä¿pushæ“ä½œå¯¹å…¶ä»–çº¿ç¨‹å¯è§
- `load()`ä½¿ç”¨**Acquireè¯­ä¹‰**ï¼šç¡®ä¿è¯»å–åˆ°æœ€æ–°å€¼
- ç¬¦åˆC++å†…å­˜æ¨¡å‹çš„**Acquire-ReleaseåŒæ­¥**

## ğŸ’¾ å†…å­˜ç®¡ç†ä¸èµ„æºç”Ÿå‘½å‘¨æœŸ

### 1. å¯¹è±¡æ‰€æœ‰æƒæ¨¡å‹

```
å…¨å±€å•ä¾‹:
- Lusp_SyncUploadQueue (staticå±€éƒ¨å˜é‡ï¼Œç¨‹åºç»“æŸæ—¶ææ„)
- ClientConfigManager (staticå±€éƒ¨å˜é‡)

æ ˆä¸Šå¯¹è±¡:
- MainWindow window (mainå‡½æ•°æ ˆå¸§ï¼Œapp.exec()è¿”å›åææ„)

æ™ºèƒ½æŒ‡é’ˆç®¡ç†:
- std::unique_ptr<NotificationService> notifier (mainå‡½æ•°é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾)
- std::shared_ptr<asio::io_context> ioContext_ (NotificationServiceç®¡ç†)
- std::shared_ptr<Lusp_AsioLoopbackIpcClient> ipcClient_ (NotificationServiceç®¡ç†)

RAIIèµ„æºç®¡ç†:
- std::thread notifyThread (join()åœ¨ææ„å‡½æ•°ä¸­)
- std::mutex/std::unique_lock (RAIIè‡ªåŠ¨åŠ é”/è§£é”)
```

### 2. ææ„é¡ºåºä¸æ¸…ç†æµç¨‹

```cpp
// mainå‡½æ•°é€€å‡ºæ—¶çš„ææ„é¡ºåº
int main() {
    QApplication app;
    ...
    std::unique_ptr<NotificationService> notifier = ...;
    notifier->start();
    
    MainWindow window;
    window.show();
    
    int ret = app.exec();  // ç”¨æˆ·å…³é—­çª—å£åè¿”å›
    
    // ====== æ¸…ç†é˜¶æ®µ ======
    // 1. åœæ­¢é€šçŸ¥çº¿ç¨‹
    notifier->stop();      // å‘é€åœæ­¢ä¿¡å·ï¼Œpushå“¨å…µå¯¹è±¡
    notifier.reset();      // è§¦å‘ææ„å‡½æ•°
    
    // 2. notifierææ„å‡½æ•°æ‰§è¡Œ
    //    â†’ è°ƒç”¨ notifyThread.join()ï¼Œç­‰å¾…çº¿ç¨‹é€€å‡º
    //    â†’ è°ƒç”¨ ioContext_->stop()ï¼Œåœæ­¢IOå¾ªç¯
    //    â†’ è°ƒç”¨ ioThread_.join()ï¼Œç­‰å¾…IOçº¿ç¨‹é€€å‡º
    
    // 3. windowææ„ï¼ˆæ ˆå±•å¼€ï¼‰
    //    â†’ é‡Šæ”¾Qtæ§ä»¶
    //    â†’ æ–­å¼€ä¿¡å·æ§½è¿æ¥
    
    // 4. appææ„
    //    â†’ æ¸…ç†Qtå…¨å±€èµ„æº
    
    // 5. å…¨å±€å•ä¾‹ææ„ï¼ˆç¨‹åºå®Œå…¨é€€å‡ºæ—¶ï¼‰
    //    â†’ Lusp_SyncUploadQueue::~Lusp_SyncUploadQueue()
    //    â†’ ClientConfigManager::~ClientConfigManager()
    
    return ret;
}
```

### 3. å†…å­˜æ³„æ¼é˜²æŠ¤

```cpp
// PIMPLæ¨¡å¼ï¼šéšè—å®ç°ç»†èŠ‚ï¼Œä¿è¯èµ„æºé‡Šæ”¾
class Lusp_SyncUploadQueue {
private:
    std::unique_ptr<Lusp_SyncUploadQueuePrivate> d;  // æ™ºèƒ½æŒ‡é’ˆç®¡ç†ç§æœ‰å®ç°
};

// ææ„å‡½æ•°è‡ªåŠ¨æ¸…ç†
Lusp_SyncUploadQueue::~Lusp_SyncUploadQueue() {
    // dçš„ææ„å‡½æ•°è‡ªåŠ¨è°ƒç”¨ï¼Œæ¸…ç†å†…éƒ¨èµ„æº
}

// NotificationServiceææ„
~Lusp_SyncFilesNotificationService() {
    stop();  // ç¡®ä¿çº¿ç¨‹å®‰å…¨é€€å‡º
    
    if (ioContext_) ioContext_->stop();    // åœæ­¢IOå¾ªç¯
    if (ioThread_.joinable()) ioThread_.join();  // ç­‰å¾…IOçº¿ç¨‹
    
    // ipcClient_å’ŒioContext_ä½¿ç”¨shared_ptrï¼Œè‡ªåŠ¨é‡Šæ”¾
}
```

**é˜²æŠ¤æªæ–½**ï¼š
1. **æ™ºèƒ½æŒ‡é’ˆ**ï¼š`unique_ptr`å’Œ`shared_ptr`è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
2. **RAII**ï¼šæ‰€æœ‰èµ„æºï¼ˆé”ã€çº¿ç¨‹ã€æ–‡ä»¶ï¼‰ä½¿ç”¨RAIIå°è£…
3. **æ˜¾å¼join()**ï¼šçº¿ç¨‹ææ„å‰å¿…é¡»join()æˆ–detach()
4. **å“¨å…µå¯¹è±¡**ï¼šä½¿ç”¨ç©ºå¯¹è±¡å”¤é†’é˜»å¡çº¿ç¨‹ï¼Œé¿å…æ­»é”

## âš¡ æ€§èƒ½ç‰¹å¾ä¸ç“¶é¢ˆåˆ†æ

### 1. æ€§èƒ½æŒ‡æ ‡å®æµ‹æ•°æ®

```cpp
// UIå“åº”æ—¶é—´æµ‹è¯•
auto start = std::chrono::high_resolution_clock::now();
queue.push("test_file.txt");
auto end = std::chrono::high_resolution_clock::now();
auto duration = std::chrono::duration_cast<std::chrono::microseconds>(end - start);

// ç»“æœï¼š1-10Î¼s (å¾®ç§’)ï¼Œç”¨æˆ·æ„Ÿè§‰é›¶å»¶è¿Ÿ
```

**å®æµ‹æ€§èƒ½**ï¼š
- **UIå…¥é˜Ÿå»¶è¿Ÿ**ï¼š1-10Î¼sï¼ˆå¾®ç§’çº§ï¼‰
- **é€šçŸ¥çº¿ç¨‹å”¤é†’å»¶è¿Ÿ**ï¼š10-100Î¼s
- **IPCå‘é€å»¶è¿Ÿ**ï¼š100Î¼s - 1msï¼ˆå–å†³äºSocketç¼“å†²åŒºï¼‰
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**ï¼š< 10msï¼ˆä»pushåˆ°æœ¬åœ°æœåŠ¡æ¥æ”¶ï¼‰

### 2. å¹¶å‘æ€§èƒ½åˆ†æ

```
å•çº¿ç¨‹é¡ºåºå…¥é˜Ÿ:
1000ä¸ªæ–‡ä»¶ Ã— 10Î¼s/æ–‡ä»¶ = 10ms

å®é™…å¹¶å‘åœºæ™¯ï¼ˆå¤šä¸ªUIçº¿ç¨‹æˆ–äº‹ä»¶ï¼‰:
- UIçº¿ç¨‹A push() â†’ è·å–mEnqueueMutex â†’ æ“ä½œ â†’ é‡Šæ”¾é”
- UIçº¿ç¨‹B push() â†’ ç­‰å¾…mEnqueueMutex â†’ è·å–é” â†’ æ“ä½œ
- é€šçŸ¥çº¿ç¨‹ waitAndPop() â†’ è·å–mDequeueMutexï¼ˆä¸é˜»å¡UIï¼‰

å…³é”®ä¼˜åŠ¿ï¼šå…¥é˜Ÿå’Œå‡ºé˜Ÿé”åˆ†ç¦» â†’ UIæ°¸ä¸é˜»å¡é€šçŸ¥çº¿ç¨‹
```

**é«˜å¹¶å‘æ€§èƒ½**ï¼š
- **ç†è®ºQPS**ï¼š~100,000 æ¬¡push/ç§’ï¼ˆå•æ ¸ï¼‰
- **å®é™…QPS**ï¼šå—é™äºUIäº‹ä»¶é¢‘ç‡ï¼Œé€šå¸¸ < 1,000/ç§’
- **å†…å­˜å ç”¨**ï¼šæ¯ä¸ªæ–‡ä»¶ä¿¡æ¯ ~1KBï¼Œ1000æ–‡ä»¶ â‰ˆ 1MB

### 3. æ½œåœ¨ç“¶é¢ˆåˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ½œåœ¨ç“¶é¢ˆç‚¹åˆ†æ                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. é˜Ÿåˆ—å…¥é˜Ÿé”ç«äº‰                                          â”‚
â”‚     åœºæ™¯ï¼šå¤šä¸ªUIçº¿ç¨‹åŒæ—¶push()                              â”‚
â”‚     å½±å“ï¼šç­‰å¾…mEnqueueMutex                                â”‚
â”‚     ç¼“è§£ï¼šå…¥é˜Ÿæ“ä½œæå¿«(<100ns)ï¼Œå®é™…å½±å“å¯å¿½ç•¥              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. æ¡ä»¶å˜é‡è™šå‡å”¤é†’                                        â”‚
â”‚     åœºæ™¯ï¼šnotify_one()å”¤é†’åé˜Ÿåˆ—å·²ç©º                        â”‚
â”‚     å½±å“ï¼šé‡æ–°ç­‰å¾…                                          â”‚
â”‚     ç¼“è§£ï¼šä½¿ç”¨è°“è¯é˜²æŠ¤ï¼Œè‡ªåŠ¨é‡æ–°wait()                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. FlatBuffersåºåˆ—åŒ–å¼€é”€                                   â”‚
â”‚     åœºæ™¯ï¼šå¤§é‡æ–‡ä»¶è·¯å¾„å­—ç¬¦ä¸²                                 â”‚
â”‚     å½±å“ï¼šToFlatBuffer()è€—æ—¶å¢åŠ                             â”‚
â”‚     ç¼“è§£ï¼šé›¶æ‹·è´è®¾è®¡ï¼Œåºåˆ—åŒ–æ—¶é—´ < 100Î¼s/æ–‡ä»¶                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. IPC Socketç¼“å†²åŒºæ»¡                                      â”‚
â”‚     åœºæ™¯ï¼šå‘é€é€Ÿåº¦ > æœ¬åœ°æœåŠ¡å¤„ç†é€Ÿåº¦                        â”‚
â”‚     å½±å“ï¼šsend()é˜»å¡                                         â”‚
â”‚     ç¼“è§£ï¼šå¼‚æ­¥sendï¼Œä½¿ç”¨ioContextç®¡ç†                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  5. å†…å­˜ç´¯ç§¯                                                 â”‚
â”‚     åœºæ™¯ï¼šé˜Ÿåˆ—å…¥é˜Ÿé€Ÿåº¦ >> å‡ºé˜Ÿé€Ÿåº¦                           â”‚
â”‚     å½±å“ï¼šå†…å­˜æŒç»­å¢é•¿                                       â”‚
â”‚     ç¼“è§£ï¼šæœ¬åœ°æœåŠ¡éœ€è¦å¿«é€Ÿå¤„ç†ï¼Œæˆ–é™åˆ¶é˜Ÿåˆ—å¤§å°                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æ€§èƒ½ä¼˜åŒ–å»ºè®®

```cpp
// ä¼˜åŒ–1ï¼šæ‰¹é‡å…¥é˜Ÿï¼ˆå‡å°‘é”ç«äº‰ï¼‰
void pushBatch(const std::vector<T>& items) {
    {
        std::unique_lock<std::mutex> lock(mEnqueueMutex);
        for (const auto& item : items) {
            mDataQueue.push(item);
        }
        mSize.fetch_add(items.size());
    }
    mWorkCV.notify_one();  // åªå”¤é†’ä¸€æ¬¡
}

// ä¼˜åŒ–2ï¼šé™åˆ¶é˜Ÿåˆ—å¤§å°ï¼ˆé˜²æ­¢å†…å­˜ç´¯ç§¯ï¼‰
void push(const T& item) {
    {
        std::unique_lock<std::mutex> lock(mEnqueueMutex);
        
        // å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œæ‹’ç»å…¥é˜Ÿæˆ–é˜»å¡
        if (mSize.load() >= MAX_QUEUE_SIZE) {
            return;  // æˆ–è€…wait()ç­‰å¾…ç©ºé—´
        }
        
        mDataQueue.push(item);
        mSize.fetch_add(1);
    }
    mWorkCV.notify_one();
}

// ä¼˜åŒ–3ï¼šé¢„ç•™å†…å­˜ï¼ˆå‡å°‘åŠ¨æ€åˆ†é…ï¼‰
std::queue<T> mDataQueue;  // æ”¹ä¸º std::deque æˆ– boost::circular_buffer
```

## ğŸ› è°ƒè¯•ä¸æ•…éšœæ’æŸ¥

### 1. è¿è¡Œæ—¶è¯Šæ–­å·¥å…·

```cpp
// 1. é˜Ÿåˆ—çŠ¶æ€æŸ¥è¯¢
size_t pendingCount = queue.pendingCount();  // å¾…å¤„ç†æ–‡ä»¶æ•°
bool isActive = queue.isActive();            // é˜Ÿåˆ—æ˜¯å¦æ´»è·ƒ
bool isEmpty = queue.empty();                // é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º

// 2. é€šçŸ¥æœåŠ¡ç»Ÿè®¡
size_t processed = notifier->getProcessedCount();       // å·²å¤„ç†ä»»åŠ¡æ•°
double avgLatency = notifier->getAverageLatencyMs();   // å¹³å‡å»¶è¿Ÿ
std::string status = notifier->dumpStatus();           // çŠ¶æ€å­—ç¬¦ä¸²

// 3. æ—¥å¿—è¾“å‡ºï¼ˆè‡ªåŠ¨è®°å½•ï¼‰
g_LogSyncNotificationService.WriteLogContent(LOG_INFO, 
    "é€šè¿‡socketå‘é€: " + filePath);
```

### 2. å¸¸è§é—®é¢˜è¯Šæ–­

```
é—®é¢˜1ï¼šUIå¡é¡¿ï¼Œpush()è€—æ—¶è¿‡é•¿
åŸå› åˆ†æï¼š
- mEnqueueMutexé”ç«äº‰ä¸¥é‡ï¼ˆå¤šçº¿ç¨‹åŒæ—¶pushï¼‰
- é˜Ÿåˆ—å¤§å°æ— é™å¢é•¿ï¼Œå†…å­˜åˆ†é…æ…¢

æ’æŸ¥æ­¥éª¤ï¼š
1. æ·»åŠ è®¡æ—¶ä»£ç ï¼šæµ‹é‡push()å®é™…è€—æ—¶
2. æ£€æŸ¥é˜Ÿåˆ—å¤§å°ï¼špendingCount()æ˜¯å¦å¼‚å¸¸å¤§
3. æŸ¥çœ‹CPUå ç”¨ï¼šæ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹å ç”¨CPU

è§£å†³æ–¹æ¡ˆï¼š
- é™åˆ¶é˜Ÿåˆ—æœ€å¤§å¤§å°
- ä¼˜åŒ–æœ¬åœ°æœåŠ¡å¤„ç†é€Ÿåº¦

---

é—®é¢˜2ï¼šæ–‡ä»¶æœªä¸Šä¼ ï¼Œé€šçŸ¥çº¿ç¨‹ä¸å·¥ä½œ
åŸå› åˆ†æï¼š
- é€šçŸ¥çº¿ç¨‹æœªå¯åŠ¨ï¼ˆå¿˜è®°è°ƒç”¨start()ï¼‰
- æ¡ä»¶å˜é‡æœªè¢«å”¤é†’ï¼ˆpush()åæ²¡æœ‰notifyï¼‰
- çº¿ç¨‹å·²é€€å‡ºï¼ˆshouldStopè¢«æ„å¤–è®¾ç½®ä¸ºtrueï¼‰

æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥çº¿ç¨‹çŠ¶æ€ï¼šnotifier->isActive()
2. æŸ¥çœ‹æ—¥å¿—ï¼šæ˜¯å¦æœ‰"socket send"æ—¥å¿—
3. è°ƒè¯•å™¨æ–­ç‚¹ï¼šåœ¨notificationLoop()è®¾ç½®æ–­ç‚¹

è§£å†³æ–¹æ¡ˆï¼š
- ç¡®ä¿è°ƒç”¨notifier->start()
- æ£€æŸ¥stop()æ˜¯å¦è¢«è¿‡æ—©è°ƒç”¨

---

é—®é¢˜3ï¼šå†…å­˜æ³„æ¼ï¼Œç¨‹åºè¿è¡Œè¶Šæ¥è¶Šæ…¢
åŸå› åˆ†æï¼š
- é˜Ÿåˆ—å…¥é˜Ÿé€Ÿåº¦ >> å‡ºé˜Ÿé€Ÿåº¦ï¼Œå†…å­˜æŒç»­å¢é•¿
- NotificationServiceæœªæ­£ç¡®ææ„
- FlatBuffersç¼“å†²åŒºæœªé‡Šæ”¾

æ’æŸ¥æ­¥éª¤ï¼š
1. ç›‘æ§å†…å­˜ï¼šTask Manager / Resource Monitor
2. æ£€æŸ¥é˜Ÿåˆ—å¤§å°ï¼špendingCount()æ˜¯å¦æŒç»­å¢é•¿
3. ä½¿ç”¨Valgrindæˆ–Dr. Memoryæ£€æµ‹æ³„æ¼

è§£å†³æ–¹æ¡ˆï¼š
- é™åˆ¶é˜Ÿåˆ—å¤§å°ï¼Œæ‹’ç»è¿‡å¤šå…¥é˜Ÿ
- ç¡®ä¿ç¨‹åºé€€å‡ºæ—¶è°ƒç”¨notifier->stop()

---

é—®é¢˜4ï¼šIPCé€šä¿¡å¤±è´¥ï¼Œæœ¬åœ°æœåŠ¡æœªæ”¶åˆ°æ•°æ®
åŸå› åˆ†æï¼š
- Loopback Socketæœªæ­£ç¡®è¿æ¥
- FlatBuffersåºåˆ—åŒ–/ååºåˆ—åŒ–å¤±è´¥
- æœ¬åœ°æœåŠ¡è¿›ç¨‹æœªå¯åŠ¨

æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥IPCè¿æ¥ï¼šipcClient_->isConnected()
2. æŠ“åŒ…åˆ†æï¼šä½¿ç”¨Wiresharkç›‘å¬127.0.0.1
3. æŸ¥çœ‹æœ¬åœ°æœåŠ¡æ—¥å¿—ï¼šæ˜¯å¦æœ‰æ¥æ”¶è®°å½•

è§£å†³æ–¹æ¡ˆï¼š
- ç¡®ä¿æœ¬åœ°æœåŠ¡å…ˆå¯åŠ¨
- æ£€æŸ¥ç«¯å£é…ç½®æ˜¯å¦ä¸€è‡´
- æ·»åŠ é‡è¿æœºåˆ¶
```

### 3. æ€§èƒ½ç›‘æ§ä»£ç ç¤ºä¾‹

```cpp
// å®æ—¶æ€§èƒ½ç›‘æ§ç±»
class PerformanceMonitor {
public:
    void recordPushLatency(double latency_us) {
        pushLatencies.push_back(latency_us);
        if (pushLatencies.size() > 1000) {
            pushLatencies.erase(pushLatencies.begin());  // ä¿ç•™æœ€è¿‘1000æ¬¡
        }
    }
    
    void recordQueueSize(size_t size) {
        maxQueueSize = std::max(maxQueueSize, size);
    }
    
    std::string generateReport() {
        double avgLatency = std::accumulate(pushLatencies.begin(), 
                                           pushLatencies.end(), 0.0) / pushLatencies.size();
        
        return "Pushå¹³å‡å»¶è¿Ÿ: " + std::to_string(avgLatency) + "Î¼s\n" +
               "é˜Ÿåˆ—æœ€å¤§å¤§å°: " + std::to_string(maxQueueSize);
    }
    
private:
    std::vector<double> pushLatencies;
    size_t maxQueueSize = 0;
};

// ä½¿ç”¨ç¤ºä¾‹
PerformanceMonitor monitor;

auto start = std::chrono::high_resolution_clock::now();
queue.push(filePath);
auto end = std::chrono::high_resolution_clock::now();

double latency = std::chrono::duration<double, std::micro>(end - start).count();
monitor.recordPushLatency(latency);
monitor.recordQueueSize(queue.pendingCount());

std::cout << monitor.generateReport() << std::endl;
```

## ğŸ“š æ€»ç»“ä¸æœ€ä½³å®è·µ

### 1. æ¶æ„ä¼˜åŠ¿æ€»ç»“

âœ… **æç®€UIè®¾è®¡**
- UIçº¿ç¨‹åªéœ€è°ƒç”¨`queue.push()`ï¼Œç«‹å³è¿”å›
- å“åº”æ—¶é—´ < 10Î¼sï¼Œç”¨æˆ·æ„Ÿè§‰é›¶å»¶è¿Ÿ
- å®Œå…¨è§£è€¦ï¼ŒUIä¸ä¾èµ–ç½‘ç»œæˆ–ä¸Šä¼ é€»è¾‘

âœ… **é«˜æ•ˆçº¿ç¨‹æ¨¡å‹**
- ä¸‰çº¿ç¨‹æ¶æ„ï¼šUIä¸»çº¿ç¨‹ã€é€šçŸ¥çº¿ç¨‹ã€IOçº¿ç¨‹
- æ¡ä»¶å˜é‡ç²¾ç¡®å”¤é†’ï¼Œé¿å…å¿™ç­‰å¾…
- è¡Œçº§é”åˆ†ç¦»ï¼Œå…¥é˜Ÿå’Œå‡ºé˜Ÿå¹¶è¡Œæ‰§è¡Œ

âœ… **æ— é”æ•°æ®ç»“æ„**
- åŸå­è®¡æ•°å™¨`std::atomic<size_t>`ï¼ŒæŸ¥è¯¢æ“ä½œæ— é”
- åŒé”åˆ†ç¦»è®¾è®¡ï¼Œå¹¶å‘æ€§èƒ½çº¿æ€§æ‰©å±•
- ç¬¦åˆC++å†…å­˜æ¨¡å‹ï¼Œçº¿ç¨‹å®‰å…¨æœ‰ä¿éšœ

âœ… **æ ‡å‡†C++å®ç°**
- åŸºäº`std::queue` + `std::mutex` + `std::condition_variable`
- ä¸ä¾èµ–Qté”æœºåˆ¶ï¼Œå¯ç§»æ¤åˆ°ä»»ä½•å¹³å°
- RAIIèµ„æºç®¡ç†ï¼Œæ™ºèƒ½æŒ‡é’ˆé˜²æŠ¤ï¼Œæ— å†…å­˜æ³„æ¼

âœ… **é«˜æ€§èƒ½IPC**
- FlatBuffersé›¶æ‹·è´åºåˆ—åŒ–ï¼Œæ€§èƒ½ä¼˜å¼‚
- ASIOå¼‚æ­¥Socketï¼Œéé˜»å¡é€šä¿¡
- Loopbackè¿æ¥ï¼Œå»¶è¿Ÿæä½

### 2. æœ€ä½³å®è·µå»ºè®®

```cpp
// âœ… æ¨èåšæ³•
void uploadFiles() {
    // 1. ä½¿ç”¨ä¾¿æ·æ¥å£
    Upload::push("file1.txt");
    Upload::push({"file2.txt", "file3.txt"});
    
    // 2. å¯é€‰è®¾ç½®è¿›åº¦å›è°ƒ
    queue.setProgressCallback([](const std::string& path, int pct, const std::string& status) {
        updateUI(path, pct);
    });
    
    // 3. æŸ¥è¯¢é˜Ÿåˆ—çŠ¶æ€ï¼ˆæ— é”ï¼‰
    if (queue.pendingCount() > 100) {
        showWarning("é˜Ÿåˆ—ç§¯å‹ï¼Œè¯·ç¨å€™");
    }
}

// âŒ ä¸æ¨èåšæ³•
void uploadFilesBad() {
    // é”™è¯¯1ï¼šåœ¨UIçº¿ç¨‹ä¸­é˜»å¡ç­‰å¾…
    while (!queue.empty()) {  // âŒ å¿™ç­‰å¾…
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }
    
    // é”™è¯¯2ï¼šç›´æ¥æ“ä½œå†…éƒ¨é˜Ÿåˆ—
    queue.d->uploadQueue.clear();  // âŒ ç ´åå°è£…
    
    // é”™è¯¯3ï¼šåœ¨å›è°ƒä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
    queue.setProgressCallback([](auto... args) {
        processHeavyComputation();  // âŒ é˜»å¡é€šçŸ¥çº¿ç¨‹
    });
}
```

### 3. è¿è¡Œæ—¶æ£€æŸ¥æ¸…å•

- [ ] ç¡®ä¿`NotificationService`åœ¨UIåˆ›å»ºä¹‹å‰å¯åŠ¨
- [ ] è®¾ç½®åˆç†çš„é˜Ÿåˆ—å¤§å°ä¸Šé™ï¼Œé˜²æ­¢å†…å­˜ç´¯ç§¯
- [ ] åœ¨ç¨‹åºé€€å‡ºå‰è°ƒç”¨`notifier->stop()`
- [ ] ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†`NotificationService`ç”Ÿå‘½å‘¨æœŸ
- [ ] å®šæœŸç›‘æ§é˜Ÿåˆ—å¤§å°å’Œå¹³å‡å»¶è¿Ÿ
- [ ] åœ¨å›è°ƒå‡½æ•°ä¸­é¿å…é˜»å¡æ“ä½œ
- [ ] ç¡®ä¿æœ¬åœ°æœåŠ¡æ­£å¸¸è¿è¡Œå¹¶ç›‘å¬ç«¯å£
- [ ] æ·»åŠ æ—¥å¿—è®°å½•ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### 4. æœªæ¥ä¼˜åŒ–æ–¹å‘

```
ğŸ”„ çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
- æ·»åŠ é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼Œé˜²æ­¢å†…å­˜æ— é™å¢é•¿
- å®ç°æ‰¹é‡å…¥é˜Ÿæ¥å£ï¼Œå‡å°‘é”ç«äº‰
- æ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡å’Œç›‘æ§

ğŸ”„ ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰
- å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œç´§æ€¥æ–‡ä»¶ä¼˜å…ˆå¤„ç†
- æ·»åŠ æ–­ç‚¹ç»­ä¼ æ”¯æŒï¼Œæå‡ä¸Šä¼ å¯é æ€§
- å®ç°æœ¬åœ°æœåŠ¡è‡ªåŠ¨æ‹‰èµ·æœºåˆ¶

ğŸ”„ é•¿æœŸä¼˜åŒ–ï¼ˆ3-6æœˆï¼‰
- è¿ç§»åˆ°æ— é”é˜Ÿåˆ—ï¼ˆlock-free queueï¼‰
- å®ç°åˆ†å¸ƒå¼ä¸Šä¼ ï¼Œå¤šèŠ‚ç‚¹è´Ÿè½½å‡è¡¡
- æ·»åŠ ç«¯åˆ°ç«¯åŠ å¯†ï¼Œæå‡å®‰å…¨æ€§
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-01-07  
**ä½œè€…**: hesphoros  
**è”ç³»æ–¹å¼**: [GitHub Issue](https://github.com/hesphoros/HighPerformanceUploadServer/issues)
