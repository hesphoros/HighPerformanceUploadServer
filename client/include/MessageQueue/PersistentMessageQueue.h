#ifndef PRESISTENT_MESSAGE_QUEUE_H
#define PRESISTENT_MESSAGE_QUEUE_H

#include <atomic>
#include <cstdint>
#include <filesystem>
#include <fstream>
#include <memory>
#include <mutex>
#include <optional>
#include <string>
#include <vector>



/**
 * @brief æ¶ˆæ¯ç»“æ„ä½“
 */
struct IpcMessage
{
    uint64_t                id;                    // æ¶ˆæ¯å”¯ä¸€ID
    uint64_t                timestamp;             // æ—¶é—´æˆ³(ms)
    uint32_t                priority;              // ä¼˜å…ˆçº§(0æœ€é«˜)
    std::vector<uint8_t>    data;                  // æ¶ˆæ¯æ•°æ®

    IpcMessage()
        : id(0), timestamp(0), priority(0) {
    }

    IpcMessage(uint64_t msg_id, const std::vector<uint8_t>& msg_data, uint32_t msg_priority = 0)
        : id(msg_id)
        , timestamp(std::chrono::duration_cast<std::chrono::milliseconds>(
            std::chrono::system_clock::now().time_since_epoch())
            .count())
        , priority(msg_priority)
        , data(msg_data) {
    }
};

/**
 * @brief é«˜æ€§èƒ½æ— é”æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—
 *
 * ç‰¹æ€§:
 * 1. æ— é”å†…å­˜é˜Ÿåˆ—(ä½¿ç”¨ç¯å½¢ç¼“å†²åŒº)
 * 2. å†…å­˜æ»¡åæº¢å‡ºåˆ°ç£ç›˜
 * 3. æŒ‰ä¼˜å…ˆçº§æ¢å¤æ¶ˆæ¯
 * 4. æ”¯æŒæŒä¹…åŒ–å’Œæ¢å¤
 */
class PersistentMessageQueue
{
public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param persist_dir    æŒä¹…åŒ–ç›®å½•
     * @param memory_capacity å†…å­˜é˜Ÿåˆ—å®¹é‡(æ¡æ•°)
     * @param max_disk_size   æœ€å¤§ç£ç›˜å ç”¨(å­—èŠ‚)
     */
    explicit PersistentMessageQueue(const std::filesystem::path& persist_dir,
        size_t memory_capacity = 1024,
        size_t max_disk_size = 100 * 1024 * 1024);

    ~PersistentMessageQueue();

    // ç¦æ­¢æ‹·è´
    PersistentMessageQueue(const PersistentMessageQueue&) = delete;
    PersistentMessageQueue& operator=(const PersistentMessageQueue&) = delete;

    /**
     * @brief å…¥é˜Ÿ(æ— é”ï¼Œç”Ÿäº§è€…è°ƒç”¨)
     * @param message æ¶ˆæ¯
     * @return æ˜¯å¦æˆåŠŸ(falseè¡¨ç¤ºé˜Ÿåˆ—å·²æ»¡)
     */
    bool enqueue(IpcMessage&& message);

    /**
     * @brief  å‡ºé˜Ÿ(æ— é”ï¼Œæ¶ˆè´¹è€…è°ƒç”¨)
     * @return æ¶ˆæ¯(å¦‚æœé˜Ÿåˆ—ä¸ºç©ºè¿”å›nullopt)
     */
    std::optional<IpcMessage> dequeue();

    /**
     * @brief æŸ¥çœ‹é˜Ÿé¦–æ¶ˆæ¯ä½†ä¸åˆ é™¤(æ— é”ï¼Œç”¨äºå‘é€å¤±è´¥é‡è¯•)
     * @return æ¶ˆæ¯(å¦‚æœé˜Ÿåˆ—ä¸ºç©ºè¿”å›nullopt)
     */
    std::optional<IpcMessage> peek() const;

    /**
     * @brief åˆ é™¤é˜Ÿé¦–æ¶ˆæ¯(å‘é€æˆåŠŸåè°ƒç”¨)
     * @return æ˜¯å¦æˆåŠŸ
     */
    bool pop_front();

    /**
     * @brief è·å–é˜Ÿåˆ—å¤§å°(è¿‘ä¼¼å€¼)
     */
    size_t size() const;

    /**
     * @brief æ˜¯å¦ä¸ºç©º
     */
    bool empty() const;

    /**
     * @brief æ¸…ç©ºé˜Ÿåˆ—
     */
    void clear();

    /**
     * @brief ä»ç£ç›˜åŠ è½½æ¶ˆæ¯åˆ°å†…å­˜
     * @return åŠ è½½çš„æ¶ˆæ¯æ•°
     */
    size_t load_from_disk();

    /**
     * @brief åˆ·æ–°å†…å­˜é˜Ÿåˆ—åˆ°ç£ç›˜
     * @return åˆ·æ–°çš„æ¶ˆæ¯æ•°
     */
    size_t flush_to_disk();

    /**
     * @brief è·å–ç»Ÿè®¡ä¿¡æ¯
     */
    struct Statistics
    {
        size_t memory_size;       // å†…å­˜é˜Ÿåˆ—å¤§å°
        size_t disk_size;         // ç£ç›˜é˜Ÿåˆ—å¤§å°
        size_t total_enqueued;    // æ€»å…¥é˜Ÿæ•°
        size_t total_dequeued;    // æ€»å‡ºé˜Ÿæ•°
        size_t disk_bytes;        // ç£ç›˜å ç”¨å­—èŠ‚
    };
    Statistics get_statistics() const;

private:
    // å†…å­˜é˜Ÿåˆ—èŠ‚ç‚¹
    struct MemoryNode
    {
        IpcMessage          message;
        std::atomic<bool>   ready{ false }; // æ˜¯å¦å·²å†™å…¥å®Œæˆ
    };

    // ç¯å½¢ç¼“å†²åŒºç´¢å¼•
    size_t next_index(size_t idx) const { return (idx + 1) % memory_capacity_; }

    // ç£ç›˜æ“ä½œ
    bool                        write_to_disk(const IpcMessage& message);
    std::optional<IpcMessage>   read_from_disk();
    void                        rebuild_disk_index();           ///< é‡å»ºç´¢å¼•ï¼ˆä¼˜å…ˆä»idxï¼Œå¤±è´¥æ‰æ‰«ææ•°æ®æ–‡ä»¶ï¼‰
    void                        rebuild_disk_index_from_data(); ///< ä»æ•°æ®æ–‡ä»¶æ‰«æé‡å»ºç´¢å¼•
    bool                        load_disk_index();              ///< ä»ç´¢å¼•æ–‡ä»¶åŠ è½½ï¼ˆå¿«é€Ÿï¼‰
    bool                        save_disk_index();              ///< ä¿å­˜ç´¢å¼•åˆ°æ–‡ä»¶

    // åºåˆ—åŒ–
    static std::vector<uint8_t>         serialize_message(const IpcMessage& message);
    static std::optional<IpcMessage>    deserialize_message(const std::vector<uint8_t>& data);

private:
    /*   ç´¢å¼•æ–‡ä»¶æ ¼å¼  */
    // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    // â”‚                    æ–‡ä»¶å¤´(24 bytes                          â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚  Offset 0 - 3 : magic_number(uint32_t) = 0x4D515549         â”‚  â† "MQUI" é­”æ•°
    // â”‚  Offset 4 - 7 : version(uint32_t) = 1                       â”‚  â† ç‰ˆæœ¬å·
    // â”‚  Offset 8 - 15 : message_count(uint64_t)                    â”‚  â† æ¶ˆæ¯æ€»æ•°
    // â”‚  Offset 16 - 23 : total_data_size(uint64_t)                 â”‚  â† æ•°æ®æ–‡ä»¶å¤§å°
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚              ç´¢å¼•æ¡ç›®(æ¯æ¡ 12 å­—èŠ‚ï¼Œé‡å¤ N æ¬¡)                â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚[æ¡ç›® 1]                                                     â”‚
    // â”‚    Offset 0 - 7 : offset(uint64_t)        æ¶ˆæ¯åç§»é‡        â”‚
    // â”‚    Offset 8 - 11 : size(uint32_t)          æ¶ˆæ¯å¤§å°          â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚[æ¡ç›® 2]                                                     â”‚
    // â”‚    Offset 0 - 7 : offset(uint64_t)                          â”‚
    // â”‚    Offset 8 - 11 : size(uint32_t)                           â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚  ...                                                        â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚[æ¡ç›® N]                                                    â”‚
    // â”‚    Offset 0 - 7 : offset(uint64_t)                          â”‚
    // â”‚    Offset 8 - 11 : size(uint32_t)                            â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚                 ğŸ”’ CRC32 æ ¡éªŒå’Œ(4 å­—èŠ‚)                     â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚  Offset 0 - 3 : crc32_checksum(uint32_t)                   â”‚  â† å‰é¢æ‰€æœ‰å†…å®¹çš„ CRC32
    // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    /** æ•°æ®æ–‡ä»¶æ ¼å¼ */
    // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    // â”‚                    æ¶ˆæ¯ 1 (å˜é•¿)â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚  æ¶ˆæ¯å¤´(24 å­—èŠ‚ï¼Œå›ºå®š)                                          â”‚
    // â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    // â”‚  â”‚ Offset 0 - 7   : id(uint64_t)         æ¶ˆæ¯å”¯ä¸€ID          â”‚  â”‚
    // â”‚  â”‚ Offset 8 - 15 : timestamp(uint64_t)  æ—¶é—´æˆ³(æ¯«ç§’)         â”‚  â”‚
    // â”‚  â”‚ Offset 16 - 19 : priority(uint32_t)   ä¼˜å…ˆçº§(0æœ€é«˜)       â”‚  â”‚
    // â”‚  â”‚ Offset 20 - 23 : data_size(uint32_t)  æ•°æ®é•¿åº¦            â”‚  â”‚
    // â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    // â”‚  æ¶ˆæ¯æ•°æ®(data_size å­—èŠ‚ï¼Œå˜é•¿)                                â”‚
    // â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    // â”‚  â”‚ Offset 0 ~data_size - 1 : data(uint8_t[])                 â”‚  â”‚
    // â”‚  â”‚                          å®é™…æ¶ˆæ¯å†…å®¹(FlatBuffersç­‰)       â”‚  â”‚
    // â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚                    æ¶ˆæ¯ 2 (å˜é•¿)â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚  æ¶ˆæ¯å¤´(24 å­—èŠ‚)                                                â”‚
    // â”‚  æ¶ˆæ¯æ•°æ®(data_size å­—èŠ‚)                                       â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚                    æ¶ˆæ¯ 3 (å˜é•¿)â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚  ...                                                            â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚                    æ¶ˆæ¯ N(å˜é•¿)                                 â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚  æ¶ˆæ¯å¤´(24 å­—èŠ‚)                                                â”‚
    // â”‚  æ¶ˆæ¯æ•°æ®(data_size å­—èŠ‚)                                       â”‚
    // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    // å•æ¶ˆæ¯
    // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    // â”‚                æ¶ˆæ¯å¤´(24 å­—èŠ‚å›ºå®š)                   â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚[0 - 7]   id          uint64_t   8 å­—èŠ‚               â”‚
    // â”‚[8 - 15]  timestamp   uint64_t   8 å­—èŠ‚               â”‚
    // â”‚[16 - 19] priority    uint32_t   4 å­—èŠ‚               â”‚
    // â”‚[20 - 23] data_size   uint32_t   4 å­—èŠ‚               â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚            æ¶ˆæ¯æ•°æ®(data_size å­—èŠ‚å˜é•¿)              â”‚
    // â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    // â”‚[0 ... data_size - 1]  å®é™…æ¶ˆæ¯å†…å®¹                   â”‚
    // â”‚
    // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    // æ€»å¤§å° = 24 + data_size å­—èŠ‚

    // å†…å­˜é˜Ÿåˆ—
    std::unique_ptr<MemoryNode[]>                   memory_buffer_;          ///< å†…å­˜é˜Ÿåˆ—
    size_t                                          memory_capacity_;        ///< å†…å­˜é˜Ÿåˆ—å®¹é‡
    alignas(64) std::atomic<size_t>                 write_pos_{ 0 };         ///< å†™å…¥ä½ç½®ç´¢å¼•
    alignas(64) std::atomic<size_t>                 read_pos_{ 0 };          ///< è¯»å–ä½ç½®ç´¢å¼•

    // ç£ç›˜é˜Ÿåˆ—
    std::filesystem::path                           persist_dir_;            ///< æŒä¹…åŒ–ç›®å½•
    std::filesystem::path                           data_file_path_;         ///< æ•°æ®æ–‡ä»¶è·¯å¾„
    std::filesystem::path                           index_file_path_;        ///< ç´¢å¼•æ–‡ä»¶è·¯å¾„
    std::ofstream                                   data_writer_;            ///< æ•°æ®å†™å…¥æµ
    std::ifstream                                   data_reader_;            ///<  æ•°æ®è¯»å–æµ
    size_t                                          max_disk_size_;          ///< æœ€å¤§ç£ç›˜å ç”¨(å­—èŠ‚)
    std::atomic<size_t>                             current_disk_size_{ 0 }; ///< å½“å‰ç£ç›˜å ç”¨å¤§å°

    // ç£ç›˜ç´¢å¼•(offset -> size)
    mutable std::mutex                              disk_mutex_;             ///< åªä¿æŠ¤ç£ç›˜æ“ä½œ
    std::vector<std::pair<uint64_t, uint32_t>>      disk_index_;             ///< (offset, size)
    size_t                                          disk_read_pos_{ 0 };     ///< è¯»å–ä½ç½®

    // ç»Ÿè®¡
    std::atomic<uint64_t>                           total_enqueued_{ 0 };    ///< æ€»å…¥é˜Ÿæ•°
    std::atomic<uint64_t>                           total_dequeued_{ 0 };    ///< æ€»å‡ºé˜Ÿæ•°
    std::atomic<uint64_t>                           next_message_id_{ 1 };   ///< ä¸‹ä¸€ä¸ªæ¶ˆæ¯ID
};


#endif // PRESISTENT_MESSAGE_QUEUE_H